# ================================
# Input and key bindings
# ================================

# Enable Ctrl+Tab / Ctrl+Shift+Tab support for window navigation.
set -s extended-keys on
set -s extended-keys-format xterm
set -as terminal-features 'xterm-ghostty:extkeys'
set -as terminal-features 'tmux-256color:extkeys'
bind-key -n C-Tab next-window
bind-key -n C-S-Tab previous-window
bind-key -n C-BTab previous-window
bind-key -n BTab previous-window
bind-key -n S-Enter send-keys Escape "[13;2u"

# Prefix key
set -g prefix C-a

# Pane and copy-mode key bindings
bind-key h split-window -h -c "#{pane_current_path}"
bind-key v split-window -v -c "#{pane_current_path}"
bind-key c new-window -c "#{pane_current_path}"

setw -g mode-keys vi
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Reload config
bind r source-file ~/.config/tmux/tmux.conf \; display-message "tmux.conf reloaded"

# Resize panes with arrow keys
bind-key -r Left resize-pane -L 5
bind-key -r Down resize-pane -D 5
bind-key -r Up resize-pane -U 5
bind-key -r Right resize-pane -R 5

# ================================
# Plugins (TPM)
# ================================

set -g @plugin 'christoomey/vim-tmux-navigator'
set -g @plugin 'catppuccin/tmux#v2.1.3'
set -g @plugin 'azorng/tmux-smooth-scroll'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'omerxx/tmux-sessionx'
set -g @plugin 'omerxx/tmux-floax'
set -g @plugin 'Chaitanyabsprip/tmux-harpoon'
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

# ================================
# Plugin options
# ================================

# Catppuccin: show window names (manual rename friendly).
set -g @catppuccin_window_text " #W"
set -g @catppuccin_window_current_text " #W"

# Catppuccin: show only time in a right-side rounded pill.
set -g @catppuccin_date_time_icon "󰃭 "
set -g @catppuccin_date_time_text " %H:%M "
set -g @catppuccin_status_right_separator ""

# SessionX on prefix+s.
set -g @sessionx-bind 's'

# Oasis-style mode indicator (icon + mode label).
set -g @mode_indicator_color "\
#{?client_prefix,#{@thm_red},\
#{?#{==:#{pane_mode},copy-mode},#{@thm_peach},\
#{?#{==:#{pane_mode},view-mode},#{@thm_yellow},\
#{?#{||:#{==:#{pane_mode},tree-mode},#{==:#{pane_mode},client-mode}},#{@thm_green},\
#{?#{==:#{pane_mode},options-mode},#{@thm_mauve},\
#{?#{==:#{pane_mode},clock-mode},#{@thm_sky},\
#{?window_zoomed_flag,#{@thm_teal},\
#{@thm_lavender}\
}}}}}}}"

set -g @mode_indicator_icon "\
#{?client_prefix,,\
#{?#{==:#{pane_mode},copy-mode},,\
#{?#{==:#{pane_mode},view-mode},,\
#{?#{||:#{==:#{pane_mode},tree-mode},#{==:#{pane_mode},client-mode}},,\
#{?#{==:#{pane_mode},options-mode},,\
#{?#{==:#{pane_mode},clock-mode},,\
#{?window_zoomed_flag,,\
\
}}}}}}}"

set -g @mode_indicator_label "\
#{?client_prefix,COMMAND ,\
#{?#{==:#{pane_mode},copy-mode},COPY ,\
#{?#{==:#{pane_mode},view-mode},VIEW ,\
#{?#{||:#{==:#{pane_mode},tree-mode},#{==:#{pane_mode},client-mode}},CHOOSE ,\
#{?#{==:#{pane_mode},options-mode},OPTIONS ,\
#{?#{==:#{pane_mode},clock-mode},CLOCK ,\
#{?window_zoomed_flag,ZOOM,\
NORMAL \
}}}}}}}"

set -g @session_right_segment "#[fg=#{@thm_blue},bold]󰍹 #{session_name}#[default]"
set -g @mode_indicator_segment "#[fg=#{E:@mode_indicator_color}]#{E:@mode_indicator_icon} #[fg=#{E:@mode_indicator_color},bold]#{E:@mode_indicator_label}#[default]"

# Harpoon quick slots (Ctrl+Command + a/o/e/u).
set -g @harpoon_key_append1 'C-M-a'
set -g @harpoon_key_append2 'C-M-o'
set -g @harpoon_key_append3 'C-M-e'
set -g @harpoon_key_append4 'C-M-u'

# Harpoon management keys.
bind-key a run-shell "~/.config/tmux/plugins/tmux-harpoon/harpoon -A"
bind-key A run-shell "~/.config/tmux/plugins/tmux-harpoon/harpoon -a"
bind-key D run-shell "~/.config/tmux/plugins/tmux-harpoon/harpoon -d"
bind-key g run-shell "~/.config/tmux/plugins/tmux-harpoon/harpoon -l"
bind-key e run-shell "~/.config/tmux/plugins/tmux-harpoon/harpoon -e"
bind-key d detach-client

# Smooth scroll
set -g @smooth-scroll-speed "100"
set -g @smooth-scroll-easing "sine"
set -g @smooth-scroll-normal "3"
set -g @smooth-scroll-halfpage ""  # Default: pane_height / 2
set -g @smooth-scroll-fullpage ""  # Default: pane_height
set -g @smooth-scroll-mouse "true"

# Continuum + Resurrect
set -g @continuum-restore 'on'
set -g @continuum-save-interval '60'
# Keep continuum boot off; Ghostty startup is handled by LaunchAgent.
set -g @continuum-boot 'off'
set -g @resurrect-dir '~/.local/share/tmux/resurrect'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-pane-contents-area 'full'

# ================================
# Core tmux options
# ================================

set -g base-index 1
setw -g pane-base-index 1
set -g detach-on-destroy off
set -g renumber-windows on
set -g mouse on
set -g history-limit 100000
set -s escape-time 0
set -s set-clipboard external
set -s copy-command "pbcopy"
set -g allow-rename on

# Status line
set -g status-position top
set -g status-left ""
set -g status-left-length 1
set -g status-right "#{E:@mode_indicator_segment} #[fg=#{@thm_overlay0}]#[default] #{E:@session_right_segment} "
set -g status-right-length 120

# Initialize TPM (must stay at the end)
if "test ! -d ~/.config/tmux/plugins/tpm" "run 'mkdir -p ~/.config/tmux/plugins && git clone https://github.com/tmux-plugins/tpm ~/.config/tmux/plugins/tpm && ~/.config/tmux/plugins/tpm/bin/install_plugins'"
run '~/.config/tmux/plugins/tpm/tpm'
