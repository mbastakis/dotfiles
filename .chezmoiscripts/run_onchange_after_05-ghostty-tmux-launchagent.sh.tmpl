#!/bin/bash
# Keep Ghostty tmux LaunchAgent loaded and disable old continuum Terminal agent.
# hash-plist: {{ include "private_Library/LaunchAgents/com.mbastakis.ghostty-tmux.plist" | sha256sum }}

{{- if ne .chezmoi.os "darwin" }}
exit 0
{{- end }}

set -euo pipefail

domain="gui/$(id -u)"
new_label="com.mbastakis.ghostty-tmux"
new_plist="$HOME/Library/LaunchAgents/${new_label}.plist"
old_label="Tmux.Start.plist"
old_plist="$HOME/Library/LaunchAgents/${old_label}"

if [[ ! -f "$new_plist" ]]; then
    exit 0
fi

# GUI domain is unavailable in headless/non-login sessions.
if ! launchctl print "$domain" >/dev/null 2>&1; then
    exit 0
fi

launchctl bootout "$domain/$old_label" >/dev/null 2>&1 || true
if [[ -f "$old_plist" ]]; then
    rm -f "$old_plist"
fi

launchctl bootout "$domain/$new_label" >/dev/null 2>&1 || true
launchctl bootstrap "$domain" "$new_plist"
