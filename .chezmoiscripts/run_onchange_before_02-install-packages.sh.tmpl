#!/bin/bash
# Install packages from Brewfile
# Runs when Brewfile content changes
# Hash: {{ include "private_dot_config/brew/Brewfile" | sha256sum }}

{{- if ne .chezmoi.os "darwin" }}
exit 0
{{- end }}

set -euo pipefail

BREWFILE_PATH="{{ .chezmoi.sourceDir }}/private_dot_config/brew/Brewfile"

echo "Installing packages from Brewfile..."

if ! command -v brew &>/dev/null; then
    echo "Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

if [[ -t 0 && -t 1 ]]; then
    brew bundle --file="$BREWFILE_PATH"
else
    echo "Non-interactive shell detected. Skipping Mac App Store installs during chezmoi apply."
    # Skip all MAS app IDs in Brewfile to avoid interactive App Store password prompts.
    export HOMEBREW_BUNDLE_MAS_SKIP="${HOMEBREW_BUNDLE_MAS_SKIP:-937984704 1352778147 1452453066 1635403801 985367838 6740142714 1639306886}"
    brew bundle --file="$BREWFILE_PATH"
    echo "To install Mac App Store apps later, run this in an interactive terminal:"
    echo "  brew bundle --file=\$HOME/.config/brew/Brewfile"
fi

echo "Package installation complete!"
