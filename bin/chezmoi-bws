#!/usr/bin/env bash
set -euo pipefail

# chezmoi-bws â€” Wrapper that provides BWS_ACCESS_TOKEN to the bws CLI.
#
# Token resolution order:
#   1. BWS_ACCESS_TOKEN env var (if already set)
#   2. Decrypt bin/bws_token.age from chezmoi source using the age identity key
#
# The age identity key at ~/.config/chezmoi/key.txt is the single unlock secret
# needed on any new machine. Everything else derives from it.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENCRYPTED_TOKEN="$SCRIPT_DIR/bws_token.age"
AGE_IDENTITY="$HOME/.config/chezmoi/key.txt"

install_bws_if_missing() {
  if command -v bws &>/dev/null; then
    return
  fi

  echo "bws CLI not found. Installing Bitwarden Secrets Manager CLI..." >&2
  curl -fsSL https://bws.bitwarden.com/install.sh | bash

  if ! command -v bws &>/dev/null; then
    echo "Failed to install bws CLI. Please install it manually and retry." >&2
    exit 1
  fi
}

install_bws_if_missing

# 1. Env var already set
if [[ -n "${BWS_ACCESS_TOKEN:-}" ]]; then
  exec bws "$@"
fi

# 2. Decrypt token from age-encrypted file in source dir
if [[ -f "$ENCRYPTED_TOKEN" && -f "$AGE_IDENTITY" ]]; then
  if command -v age &>/dev/null; then
    token="$(age -d -i "$AGE_IDENTITY" "$ENCRYPTED_TOKEN" 2>/dev/null || true)"
  elif command -v chezmoi &>/dev/null; then
    # Fall back to chezmoi's builtin age
    token="$(chezmoi age decrypt -i "$AGE_IDENTITY" "$ENCRYPTED_TOKEN" 2>/dev/null || true)"
  fi

  if [[ -n "${token:-}" ]]; then
    export BWS_ACCESS_TOKEN="$token"
    exec bws "$@"
  fi
fi

cat >&2 <<EOF
BWS_ACCESS_TOKEN is required to render chezmoi templates.

Could not decrypt token. Ensure both files exist:
  Age identity:    $AGE_IDENTITY
  Encrypted token: $ENCRYPTED_TOKEN

Or set the token manually:
  export BWS_ACCESS_TOKEN="..."
EOF
exit 1
