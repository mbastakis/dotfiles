#!/usr/bin/env bash
set -euo pipefail

# chezmoi-bws â€” Wrapper that provides BWS_ACCESS_TOKEN to the bws CLI.
#
# Token resolution order:
#   1. BWS_ACCESS_TOKEN env var (if already set)
#   2. Decrypted token file at ~/.local/share/bws/token
#      (managed by chezmoi as an encrypted_ file, decrypted during chezmoi apply)
#
# The age passphrase prompt happens once during chezmoi apply for ALL
# encrypted files (SSH key, Supermaven config, BWS token).

TOKEN_FILE="$HOME/.local/share/bws/token"

install_bws_if_missing() {
  if command -v bws &>/dev/null; then
    return
  fi

  echo "bws CLI not found. Installing Bitwarden Secrets Manager CLI..." >&2
  curl -fsSL https://bws.bitwarden.com/install.sh | bash

  if ! command -v bws &>/dev/null; then
    echo "Failed to install bws CLI. Please install it manually and retry." >&2
    exit 1
  fi
}

install_bws_if_missing

# 1. Env var already set
if [[ -n "${BWS_ACCESS_TOKEN:-}" ]]; then
  exec bws "$@"
fi

# 2. Read token from chezmoi-managed decrypted file
if [[ -f "$TOKEN_FILE" ]]; then
  token="$(cat "$TOKEN_FILE")"
  if [[ -n "$token" ]]; then
    export BWS_ACCESS_TOKEN="$token"
    exec bws "$@"
  fi
fi

cat >&2 <<EOF
BWS_ACCESS_TOKEN is required to render chezmoi templates.

Token file not found: $TOKEN_FILE
Run 'chezmoi apply' to decrypt and deploy it.

Or set the token manually:
  export BWS_ACCESS_TOKEN="..."
EOF
exit 1
