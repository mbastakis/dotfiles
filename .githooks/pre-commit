#!/usr/bin/env bash
set -euo pipefail

# pre-commit hook for chezmoi dotfiles
# Prevents committing secrets and validates source state

RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m'

error() { echo -e "${RED}[pre-commit]${NC} $1" >&2; }
ok()    { echo -e "${GREEN}[pre-commit]${NC} $1"; }

EXIT=0

# Build the secret key pattern dynamically so this file doesn't match itself
AGE_KEY_PAT="AGE-SECRET"
AGE_KEY_PAT="${AGE_KEY_PAT}-KEY-[A-Z0-9]"

# Get list of staged files
STAGED=$(git diff --cached --name-only --diff-filter=ACM)

if [[ -z "$STAGED" ]]; then
  exit 0
fi

# 1. Block age identity files
if echo "$STAGED" | grep -qE '(^|/)key\.txt$'; then
  error "BLOCKED: age secret key (key.txt) is staged. Never commit this."
  EXIT=1
fi

# 2. Check file contents for actual age secret keys (not pattern references)
# Skip: hooks, bootstrap script, encrypted files, binary files
for file in $STAGED; do
  [[ "$file" == .githooks/* ]] && continue
  [[ "$file" == bin/bootstrap.sh ]] && continue
  [[ "$file" == *.age ]] && continue
  [[ ! -f "$file" ]] && continue
  file -b --mime "$file" 2>/dev/null | grep -q 'binary' && continue

  if grep -qE "$AGE_KEY_PAT" "$file" 2>/dev/null; then
    error "BLOCKED: $file contains an age secret key."
    EXIT=1
  fi
done

# 3. Block common secret patterns in non-encrypted, non-template files
for file in $STAGED; do
  [[ "$file" == .githooks/* ]] && continue
  [[ "$file" == bin/bootstrap.sh ]] && continue
  [[ "$file" == *.age ]] && continue
  [[ ! -f "$file" ]] && continue
  file -b --mime "$file" 2>/dev/null | grep -q 'binary' && continue

  # Check for raw API keys / tokens
  if grep -qE '(sk-or-v1-[a-f0-9]{20,}|ghp_[A-Za-z0-9]{36,}|gho_[A-Za-z0-9]{36,}|glpat-[A-Za-z0-9_-]{20,})' "$file" 2>/dev/null; then
    # Allow template files that use bitwardenSecrets
    if [[ "$file" == *.tmpl ]] && grep -q 'bitwardenSecrets' "$file" 2>/dev/null; then
      continue
    fi
    error "BLOCKED: $file may contain a raw secret. Use encryption or templates."
    EXIT=1
  fi
done

# 4. Block .DS_Store
if echo "$STAGED" | grep -q '.DS_Store'; then
  error "BLOCKED: .DS_Store file is staged."
  EXIT=1
fi

# 5. Validate chezmoi templates render without errors
if command -v chezmoi &>/dev/null; then
  if ! chezmoi execute-template '{{ .chezmoi.sourceDir }}' >/dev/null 2>&1; then
    error "chezmoi template rendering failed â€” source state may be invalid."
    EXIT=1
  fi
fi

if [[ $EXIT -eq 0 ]]; then
  ok "All checks passed."
fi

exit $EXIT
