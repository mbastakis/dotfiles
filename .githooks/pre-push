#!/usr/bin/env bash
set -euo pipefail

# pre-push hook for chezmoi dotfiles
# Validates that chezmoi apply --dry-run succeeds before pushing

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

error() { echo -e "${RED}[pre-push]${NC} $1" >&2; }
warn()  { echo -e "${YELLOW}[pre-push]${NC} $1"; }
ok()    { echo -e "${GREEN}[pre-push]${NC} $1"; }

if ! command -v chezmoi &>/dev/null; then
  warn "chezmoi not found — skipping dry-run validation."
  exit 0
fi

# Dry-run apply to validate all templates render and encrypted files decrypt
warn "Running chezmoi apply --dry-run --force ..."
if chezmoi apply --dry-run --force 2>&1; then
  ok "chezmoi dry-run passed — safe to push."
else
  error "chezmoi dry-run FAILED. Fix errors before pushing."
  exit 1
fi
