#!/usr/bin/env bash
# Add brew packages or casks to nix-darwin flake.nix
# Usage: nix-add brew <package-name>
#        nix-add cask <cask-name>

set -euo pipefail

# Configuration
FLAKE_PATH="${HOME}/.config/nix-darwin/flake.nix"
SCRIPT_NAME="$(basename "$0")"

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*"
}

show_usage() {
    cat <<EOF
Usage: ${SCRIPT_NAME} <type> <package-name>

Add brew packages or casks to nix-darwin flake.nix

Types:
    brew    Add a Homebrew formula
    cask    Add a Homebrew cask

Examples:
    ${SCRIPT_NAME} brew wget
    ${SCRIPT_NAME} cask raycast
    ${SCRIPT_NAME} brew oven-sh/bun/bun    (with tap)

Options:
    -h, --help    Show this help message

The script will:
  - Check if the package already exists
  - Add it in alphabetical order
  - Preserve formatting and indentation
  - Validate the flake after modification

EOF
}

# Validate arguments
if [[ $# -eq 0 ]] || [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    show_usage
    exit 0
fi

if [[ $# -ne 2 ]]; then
    log_error "Invalid number of arguments"
    show_usage
    exit 1
fi

TYPE="$1"
PACKAGE="$2"

# Validate type
if [[ "$TYPE" != "brew" ]] && [[ "$TYPE" != "cask" ]]; then
    log_error "Invalid type: ${TYPE}"
    log_error "Type must be either 'brew' or 'cask'"
    show_usage
    exit 1
fi

# Check if flake.nix exists
if [[ ! -f "$FLAKE_PATH" ]]; then
    log_error "flake.nix not found at: ${FLAKE_PATH}"
    exit 1
fi

# Check if package already exists
if grep -q "\"${PACKAGE}\"" "$FLAKE_PATH"; then
    log_warning "Package '${PACKAGE}' already exists in flake.nix"
    exit 0
fi

# Add package based on type
if [[ "$TYPE" == "cask" ]]; then
    # Find the line number of homebrew.casks = [
    SECTION_START=$(grep -n "homebrew.casks = \[" "$FLAKE_PATH" | cut -d: -f1)
    if [[ -z "$SECTION_START" ]]; then
        log_error "Could not find 'homebrew.casks = [' section in flake.nix"
        exit 1
    fi
    
    # Find the closing bracket
    SECTION_END=$(tail -n +$((SECTION_START + 1)) "$FLAKE_PATH" | grep -n "^\s*\];" | head -n1 | cut -d: -f1)
    SECTION_END=$((SECTION_START + SECTION_END))
    
    # Get all existing casks and add the new one
    CASKS=$(sed -n "$((SECTION_START + 1)),$((SECTION_END - 1))p" "$FLAKE_PATH" | \
            sed 's/^[[:space:]]*"\(.*\)"[[:space:]]*$/\1/' | \
            { cat; echo "$PACKAGE"; } | \
            sort -f | \
            sed 's/^/            "/' | \
            sed 's/$/\"/')
    
    # Replace the section
    {
        head -n "$SECTION_START" "$FLAKE_PATH"
        echo "$CASKS"
        tail -n +$((SECTION_END)) "$FLAKE_PATH"
    } > "${FLAKE_PATH}.tmp"
    
    mv "${FLAKE_PATH}.tmp" "$FLAKE_PATH"
    log_success "Added cask '${PACKAGE}' to flake.nix"
    
elif [[ "$TYPE" == "brew" ]]; then
    # Find the line number of homebrew.brews = [
    SECTION_START=$(grep -n "homebrew.brews = \[" "$FLAKE_PATH" | cut -d: -f1)
    if [[ -z "$SECTION_START" ]]; then
        log_error "Could not find 'homebrew.brews = [' section in flake.nix"
        exit 1
    fi
    
    # Find the closing bracket
    SECTION_END=$(tail -n +$((SECTION_START + 1)) "$FLAKE_PATH" | grep -n "^\s*\];" | head -n1 | cut -d: -f1)
    SECTION_END=$((SECTION_START + SECTION_END))
    
    # Get all existing brews and add the new one
    BREWS=$(sed -n "$((SECTION_START + 1)),$((SECTION_END - 1))p" "$FLAKE_PATH" | \
            sed 's/^[[:space:]]*"\(.*\)"[[:space:]]*$/\1/' | \
            { cat; echo "$PACKAGE"; } | \
            sort -f | \
            sed 's/^/            "/' | \
            sed 's/$/\"/')
    
    # Replace the section
    {
        head -n "$SECTION_START" "$FLAKE_PATH"
        echo "$BREWS"
        tail -n +$((SECTION_END)) "$FLAKE_PATH"
    } > "${FLAKE_PATH}.tmp"
    
    mv "${FLAKE_PATH}.tmp" "$FLAKE_PATH"
    log_success "Added brew '${PACKAGE}' to flake.nix"
fi

# Validate the flake
log_info "Validating flake..."
if cd "$(dirname "$FLAKE_PATH")" && nix flake check 2>&1 | grep -q "error:"; then
    log_error "Flake validation failed! Use 'git diff' to see changes."
    exit 1
fi

log_success "Flake validated successfully"
log_info "To apply changes, run:"
echo "    cd $(dirname "$FLAKE_PATH") && darwin-rebuild switch --flake .#simple"
