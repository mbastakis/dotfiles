#!/usr/bin/env bash
# Add git project directories to zoxide database
# Usage: add-zoxide-tree [OPTIONS] <path>

set -euo pipefail

# Configuration
SCRIPT_NAME="$(basename "$0")"
INCLUDE_HIDDEN=false
MAX_DEPTH=""
VERBOSE=false
GIT_ONLY=true

# Color output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $*"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $*"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $*"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $*"
}

show_usage() {
    cat <<EOF
Usage: ${SCRIPT_NAME} [OPTIONS] <path>

Add git project directories (containing .git folder) to zoxide database.
This registers only project root directories, making navigation more focused.

Arguments:
    <path>    Directory to scan (recursively). Use '.' for current directory.

Options:
    --all              Include all directories, not just git projects
    --max-depth N      Limit recursion depth (default: unlimited)
    --verbose, -v      Show each directory as it's added
    -h, --help         Show this help message

Examples:
    ${SCRIPT_NAME} ~/dev
    ${SCRIPT_NAME} --max-depth 2 ~/code
    ${SCRIPT_NAME} --all ~/Documents
    ${SCRIPT_NAME} -v .

Notes:
    - By default, only directories containing .git are added (git project roots)
    - Use --all to add every subdirectory instead
    - Symlinks are not followed (only the symlink path itself is added)
    - Running this multiple times on the same path is safe (increments existing entries)

EOF
}

# Parse arguments
TARGET_PATH=""

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_usage
            exit 0
            ;;
        --all)
            GIT_ONLY=false
            shift
            ;;
        --max-depth)
            if [[ -z "${2:-}" ]]; then
                log_error "--max-depth requires a numeric argument"
                exit 1
            fi
            if ! [[ "$2" =~ ^[0-9]+$ ]]; then
                log_error "--max-depth must be a positive number"
                exit 1
            fi
            MAX_DEPTH="$2"
            shift 2
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -*)
            log_error "Unknown option: $1"
            show_usage
            exit 1
            ;;
        *)
            if [[ -n "$TARGET_PATH" ]]; then
                log_error "Multiple paths provided. Please specify only one path."
                show_usage
                exit 1
            fi
            TARGET_PATH="$1"
            shift
            ;;
    esac
done

# Validation
if ! command -v zoxide >/dev/null 2>&1; then
    log_error "zoxide is not installed. Please install it first."
    exit 1
fi

if [[ -z "$TARGET_PATH" ]]; then
    log_error "No path provided"
    show_usage
    exit 1
fi

if [[ ! -e "$TARGET_PATH" ]]; then
    log_error "Path does not exist: ${TARGET_PATH}"
    exit 1
fi

if [[ ! -d "$TARGET_PATH" ]]; then
    log_error "Path is not a directory: ${TARGET_PATH}"
    exit 1
fi

# Convert to absolute path
TARGET_PATH="$(cd "$TARGET_PATH" && pwd)"

# Show configuration
log_info "Scanning: ${TARGET_PATH}"
[[ -n "$MAX_DEPTH" ]] && log_info "Max depth: ${MAX_DEPTH}"
[[ "$GIT_ONLY" == true ]] && log_info "Mode: Git projects only (directories with .git)"
[[ "$GIT_ONLY" == false ]] && log_info "Mode: All directories"
[[ "$VERBOSE" == true ]] && log_info "Verbose mode enabled"
echo ""

# Process directories
count=0

if [[ "$GIT_ONLY" == true ]]; then
    # Find directories containing .git folder
    if [[ "$VERBOSE" == true ]]; then
        # Verbose mode: show each directory as it's added
        while IFS= read -r -d '' git_dir; do
            # Get parent directory of .git folder
            project_dir="$(dirname "$git_dir")"
            log_info "Adding: ${project_dir}"
            zoxide add "$project_dir"
            ((count++))
        done < <(find "$TARGET_PATH" ${MAX_DEPTH:+-maxdepth "$MAX_DEPTH"} -type d -name ".git" -print0)
    else
        # Quiet mode
        while IFS= read -r -d '' git_dir; do
            project_dir="$(dirname "$git_dir")"
            zoxide add "$project_dir" >/dev/null 2>&1
            ((count++))
        done < <(find "$TARGET_PATH" ${MAX_DEPTH:+-maxdepth "$MAX_DEPTH"} -type d -name ".git" -print0)
    fi
else
    # Find all directories (legacy behavior with --all flag)
    find_args=("$TARGET_PATH" "-type" "d")
    if [[ -n "$MAX_DEPTH" ]]; then
        find_args+=("-maxdepth" "$MAX_DEPTH")
    fi
    find_args+=("-not" "-path" "*/.*")
    find_args+=("-print0")
    
    if [[ "$VERBOSE" == true ]]; then
        while IFS= read -r -d '' dir; do
            log_info "Adding: ${dir}"
            zoxide add "$dir"
            ((count++))
        done < <(find "${find_args[@]}")
    else
        while IFS= read -r -d '' dir; do
            zoxide add "$dir" >/dev/null 2>&1
            ((count++))
        done < <(find "${find_args[@]}")
    fi
fi

echo ""
if [[ $count -eq 0 ]]; then
    if [[ "$GIT_ONLY" == true ]]; then
        log_warning "No git projects found (no .git directories)"
    else
        log_warning "No directories found"
    fi
elif [[ $count -eq 1 ]]; then
    if [[ "$GIT_ONLY" == true ]]; then
        log_success "Added 1 git project to zoxide database"
    else
        log_success "Added 1 directory to zoxide database"
    fi
else
    if [[ "$GIT_ONLY" == true ]]; then
        log_success "Added ${count} git projects to zoxide database"
    else
        log_success "Added ${count} directories to zoxide database"
    fi
fi
