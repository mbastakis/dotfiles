#!/usr/bin/env bash
# starship-timer-display - Display timer for Starship prompt
# Usage: starship-timer-display <name> [--remaining]
#
# Outputs formatted remaining time for Starship
# With --remaining flag, outputs just the remaining seconds (for when conditions)
#
# Colors are determined by starship config based on remaining time thresholds:
#   - Green: >30 minutes remaining
#   - Yellow: <30 minutes (warning)
#   - Red: <5 minutes (critical)
#
# Outputs nothing if timer doesn't exist or is expired

set -euo pipefail

TIMER_DIR="${HOME}/.cache/starship-timers"

name="${1:-}"
flag="${2:-}"

if [[ -z "$name" ]]; then
    exit 1
fi

timer_file="$TIMER_DIR/$name"
if [[ ! -f "$timer_file" ]]; then
    exit 1
fi

expiration=$(cat "$timer_file")
now=$(date +%s)
remaining=$((expiration - now))

# Exit with error if expired (don't delete here - avoids race condition
# when multiple starship modules check the same timer simultaneously)
if [[ $remaining -le 0 ]]; then
    exit 1
fi

# If --remaining flag, just output seconds
if [[ "$flag" == "--remaining" ]]; then
    echo "$remaining"
    exit 0
fi

# Calculate hours and minutes
hours=$((remaining / 3600))
minutes=$(((remaining % 3600) / 60))

# Format time string
if [[ $hours -gt 0 ]]; then
    time_str="${hours}h ${minutes}m"
else
    time_str="${minutes}m"
fi

# Output with brackets for starship format
echo "[$time_str]"
