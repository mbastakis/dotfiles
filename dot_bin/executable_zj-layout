#!/usr/bin/env bash
# Choose a Zellij layout interactively and open it.

set -euo pipefail

log_error() {
  echo "[ERROR] $*" >&2
}

pick_command() {
  if command -v sk &>/dev/null; then
    echo "sk"
  elif command -v fzf &>/dev/null; then
    echo "fzf"
  else
    return 1
  fi
}

command -v zellij &>/dev/null || {
  log_error "zellij is not installed"
  exit 1
}

command -v fd &>/dev/null || {
  log_error "fd is not installed"
  exit 1
}

setup_check_output="$(zellij setup --check 2>/dev/null || true)"
layout_dir="$(printf '%s\n' "$setup_check_output" | awk -F'"' '/\[LAYOUT DIR\]/{print $2; exit}')"
system_data_dir="$(printf '%s\n' "$setup_check_output" | awk -F'"' '/\[SYSTEM DATA DIR\]/{print $2; exit}')"

layout_files=()

add_layout() {
  local layout_name="$1"
  local existing

  [[ -n "$layout_name" ]] || return
  for existing in "${layout_files[@]}"; do
    [[ "$existing" == "$layout_name" ]] && return
  done
  layout_files+=("$layout_name")
}

# Built-in layouts always available in Zellij
add_layout "default"
add_layout "compact"

if [[ -n "$layout_dir" ]] && [[ -d "$layout_dir" ]]; then
  while IFS= read -r layout_name; do
    [[ "$layout_name" == *.swap.kdl ]] && continue
    layout_name="${layout_name%.kdl}"
    add_layout "$layout_name"
  done < <(fd --type file --extension kdl . "$layout_dir" -x basename {} 2>/dev/null || true)
fi

if [[ -n "$system_data_dir" ]] && [[ -d "$system_data_dir/layouts" ]]; then
  while IFS= read -r layout_name; do
    [[ "$layout_name" == *.swap.kdl ]] && continue
    layout_name="${layout_name%.kdl}"
    add_layout "$layout_name"
  done < <(fd --type file --extension kdl . "$system_data_dir/layouts" -x basename {} 2>/dev/null || true)
fi

if [[ ${#layout_files[@]} -eq 0 ]]; then
  log_error "No layouts found"
  exit 1
fi

picker="$(pick_command || true)"
if [[ -z "$picker" ]]; then
  log_error "No picker found. Install 'sk' or 'fzf'."
  exit 1
fi

selected_layout="$(printf '%s\n' "${layout_files[@]}" | sort | "$picker" --prompt='zellij layout > ' || true)"

[[ -n "$selected_layout" ]] || exit 0

exec zellij --layout "$selected_layout"
