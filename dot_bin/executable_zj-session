#!/usr/bin/env bash
# Attach to an existing Zellij session or create one.

set -euo pipefail

log_error() {
  echo "[ERROR] $*" >&2
}

pick_command() {
  if command -v sk &>/dev/null; then
    echo "sk"
  elif command -v fzf &>/dev/null; then
    echo "fzf"
  else
    return 1
  fi
}

command -v zellij &>/dev/null || {
  log_error "zellij is not installed"
  exit 1
}

sessions=()
while IFS= read -r session_name; do
  [[ -n "$session_name" ]] && sessions+=("$session_name")
done < <(zellij list-sessions --short --no-formatting 2>/dev/null || true)

if [[ ${#sessions[@]} -eq 0 ]]; then
  exec zellij attach -c
fi

if [[ ${#sessions[@]} -eq 1 ]]; then
  exec zellij attach "${sessions[0]}"
fi

picker="$(pick_command || true)"
if [[ -z "$picker" ]]; then
  log_error "No picker found. Install 'sk' or 'fzf'."
  exit 1
fi

selected_session="$(printf '%s\n' "${sessions[@]}" | "$picker" --prompt='zellij session > ' || true)"

[[ -n "$selected_session" ]] || exit 0

exec zellij attach "$selected_session"
