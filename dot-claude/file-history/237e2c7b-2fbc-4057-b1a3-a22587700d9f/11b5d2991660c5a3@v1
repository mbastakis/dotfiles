stages:
  - test
  - containerize
  - release
variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: "tcp://docker:2375"
  BACKEND_DIR: "backend"
  FRONTEND_DIR: "frontend"
  ARTIFACTORY_TOKEN: ""
  ARTIFACTORY_USER: ""
  PYPI_INDEX_URL: https://${ARTIFACTORY_USER}:${ARTIFACTORY_TOKEN}@artifactory.devops.telekom.de/artifactory/api/pypi/aicc-pypi-virtual/simple
.python_job:
  image: python:3.12.11@sha256:645df645815f1403566b103b2a2bb07f6a01516bbb15078ed004e41d198ba194
  variables:
    UV_CACHE_DIR: .cache/pip
    PIP_CACHE_DIR: .cache/uv
    PYLINTHOME: .cache/pylint
    PYRIGHT_PYTHON_CACHE_DIR: .cache/pyright
    UV_INDEX_ARTIFACTORY_USERNAME: $ARTIFACTORY_USER
    UV_INDEX_ARTIFACTORY_PASSWORD: $ARTIFACTORY_TOKEN
  before_script:
    - chown -R $(whoami) .cache || echo no cache
    - mkdir -p artifacts/
    - python3 -m pip install -q uv
    - cd $BACKEND_DIR
    - export UV_CACHE_DIR=../$UV_CACHE_DIR
    - export PYLINTHOME=../$PYLINTHOME
    - export PYRIGHT_PYTHON_CACHE_DIR=../$PYRIGHT_PYTHON_CACHE_DIR
    - uv sync --group dev
  after_script:
    - mv $BACKEND_DIR/uv.lock artifacts
  artifacts:
    paths:
      - ./artifacts/
    expire_in: 1 weeks
  cache:
    - key:
        files:
          - $BACKEND_DIR/pyproject.toml
      fallback_keys:
        - cache-$CI_COMMIT_BRANCH
      paths:
        - .cache/pip
        - .cache/uv
        - .cache/pytest
        - .cache/pylint
        - .cache/pyright
  interruptible: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH
      changes:
        compare_to: 'refs/heads/main'
        paths:
          - $BACKEND_DIR/**
      when: always 
    - if: $CI_COMMIT_BRANCH
      when: manual
  allow_failure: true
.node_job:
  image: node:22-alpine
  before_script:
    - cd $FRONTEND_DIR
    - mkdir -p artifacts/
    - npm config set cache $NPM_CACHE --global
    - npm ci --include dev
  cache:
    - key:
        files:
          - $FRONTEND_DIR/package.json
      fallback_keys:
        - cache-$CI_COMMIT_BRANCH
      paths:
        - .cache/npm
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH
      changes:
        compare_to: 'refs/heads/main'
        paths:
          - $FRONTEND_DIR/**
      when: always 
    - if: $CI_COMMIT_BRANCH
      when: manual
  allow_failure: true
py_test:
  stage: test
  extends: .python_job
  variables:
    POSTGRES_USER: apa
    POSTGRES_PASSWORD: apa_password
    POSTGRES_DB: apa
    PGDATABASE: $POSTGRES_DB
    PGHOST: "postgres"
    PGPASSWORD: $POSTGRES_PASSWORD
    PGDATABASEL: $POSTGRES_DB
    PGUSER: $POSTGRES_USER
    DEFAULT_LLM_MODEL: anthropic:claude-sonnet-4-20250514
  services:
    - name: pgvector/pgvector:pg17
      alias: postgres
  script:
    - uv run --frozen --active pytest -o cache_dir=../.cache/pytest--cov-branch --cov-report term --cov-report html:../artifacts --cov-fail-under=75  --cov=src/apa/
py_lint:
  stage: test
  extends: .python_job
  script:
    - uv -q sync --only-group dev --active
    - uv -q run --active --frozen ruff check
    - uv -q run --active --frozen pyright
    - uv -q run --active --frozen typos

ts_lint:
  stage: test
  extends: .node_job
  interruptible: true
  script: ["npm run lint"]


.containerize:
  image: docker:28.3.3
  variables:
    REGISTRY: artifactory.devops.telekom.de
    REGESTRY_USER: $ARTIFACTORY_USER
    REGESTRY_PW: $ARTIFACTORY_TOKEN
  before_script: &containerize-before-script
    - apk add --update --no-cache python3 && ln -sf python3 /usr/bin/python
    - python3 -c "from pathlib import Path;import tomllib;print(tomllib.loads(Path('$BACKEND_DIR/pyproject.toml').read_text())['project']['version'])"
    - echo "$REGESTRY_PW" | docker login --username $REGESTRY_USER --password-stdin $REGISTRY
    - export PY_VERSION=$(python3 -c "from pathlib import Path;import tomllib;print(tomllib.loads(Path('$BACKEND_DIR/pyproject.toml').read_text())['project']['version'])")
    - export TS_VERSION=$(python3 -c "import json;print(json.load(open('$FRONTEND_DIR/package.json',encoding='UTF-8'))['version']);")
    - export PY_IMAGE=$REGISTRY/aicc-docker-local/$CI_PROJECT_NAME-backend
    - export TS_IMAGE=$REGISTRY/aicc-docker-local/$CI_PROJECT_NAME-frontend
    - export PY_IMAGE_LATEST=$REGISTRY/aicc-docker-local/$CI_PROJECT_NAME-backend:latest
    - export TS_IMAGE_LATEST=$REGISTRY/aicc-docker-local/$CI_PROJECT_NAME-frontend:latest
    - |
      if [ "$CI_COMMIT_BRANCH" == "main" ]; then
        echo Running in RELEASE mode!
      else
        export PY_VERSION=${PY_VERSION}-dev-${CI_COMMIT_SHORT_SHA}
        export TS_VERSION=${TS_VERSION}-dev-${CI_COMMIT_SHORT_SHA}
      fi
    - git config --global user.name "${GITLAB_SA_NAME:-pipeline}"
    - git config --global user.email "${GITLAB_SA_EMAIL:-test@example.com}"
  after_script:
    - docker logout $REGISTRY
  tags:
    - otc_run_sysbox_s
  services:
  - name: docker:28.3.3-dind
    command:
    - "--tls=false"
    - "--registry-mirror=https://dockerhub.devops.telekom.de"
    alias: docker
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: never
    - if: $CI_COMMIT_BRANCH == "cicd-main"
      when: manual
backend:
  stage: containerize
  extends: [".containerize"]
  script: &backend-containerize
    - export PY_IMAGE_TAG=$PY_IMAGE:$PY_VERSION
    - echo Building $PY_IMAGE_TAG
    - cd $BACKEND_DIR
    - docker build --cache-from $PY_IMAGE_LATEST -t $PY_IMAGE_TAG --build-arg UV_INDEX_URL=$PYPI_INDEX_URL .
    - docker push $PY_IMAGE_TAG
  needs:
    - py_test
    - py_lint
frontend:
  stage: containerize
  extends: [".containerize"]
  script:
    - export TS_IMAGE_TAG=$TS_IMAGE:$TS_VERSION
    - echo Building $TS_IMAGE_TAG
    - docker build --cache-from $TS_IMAGE_LATEST -t $TS_IMAGE_TAG -f $FRONTEND_DIR/Dockerfile.prod $FRONTEND_DIR
    - docker push $TS_IMAGE_TAG
  needs:
    - ts_lint

backend-release:
  stage: release
  extends: 
    - ".containerize"
    - "backend"
  variables:
    REGESTRY: $MTR_REGISTRY
    REGESTRY_USER: $MTR_USER
    REGESTRY_PW: $MTR_PASSWORD
  before_script: [*containerize-before-script]
  script:
    - git tag $PY_VERSION
    - *backend-containerize
    - docker tag $PY_IMAGE_TAG $PY_IMAGE_LATEST
    - docker push $PY_IMAGE_LATEST
  after_script:
    - git push --tags http://root:$SA_ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git HEAD:main
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH == "cicd-main"
      when: manual

frontend-release:
  stage: release
  extends: 
    - ".containerize"
    - "frontend"
  variables:
    REGESTRY: $MTR_REGISTRY
    REGESTRY_USER: $MTR_USER
    REGESTRY_PW: $MTR_PASSWORD
  before_script: [*containerize-before-script]
  script:
    - git tag $TS_VERSION
    - *backend-containerize
    - docker tag $TS_IMAGE_TAG $TS_IMAGE_LATEST
    - docker push $TS_IMAGE_LATEST
  after_script:
    - git push --tags http://root:$SA_ACCESS_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git HEAD:main
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH == "cicd-main"
      when: manual