{{- if .Values.agentGateway.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "apa.agentGateway.fullname" . }}
  labels:
    {{- include "apa.agentGateway.labels" . | nindent 4 }}
data:
  config.yaml: |
    # Kubernetes configuration
    kubernetes:
      namespace: {{ .Release.Namespace }}
      in_cluster: true
    
    # Logging configuration
    log_level: {{ .Values.agentGateway.logging.level | default "info" }}
    log_format: {{ .Values.agentGateway.logging.format | default "json" }}
    
    # MCP Server TTL configuration
    {{- if .Values.agentGateway.config.mcpServerTTL }}
    mcp_server_ttl: {{ .Values.agentGateway.config.mcpServerTTL }}
    {{- end }}
    
    # MCP Server definitions
    mcp_servers:
      {{- range $name, $server := .Values.agentGateway.config.mcpServers }}
      {{ $name }}:
        {{- if $server.staticUrl }}
        # Static server configuration
        static_url: {{ $server.staticUrl | quote }}
        {{- else }}
        # Dynamic server configuration
        image: {{ $server.image | quote }}
        port: {{ $server.port | default 8080 }}
        {{- if $server.command }}
        command:
          {{- range $server.command }}
          - {{ . | quote }}
          {{- end }}
        {{- end }}
        {{- if $server.env }}
        env:
          {{- range $envKey, $envValue := $server.env }}
          - name: {{ $envKey }}
            value: {{ $envValue | quote }}
          {{- end }}
        {{- end }}
        {{- if $server.resources }}
        resources:
          {{- toYaml $server.resources | nindent 10 }}
        {{- end }}
        {{- end }}
        {{- if $server.mcpPath }}
        mcp_path: {{ $server.mcpPath | quote }}
        {{- end }}
        {{- if $server.ssePath }}
        sse_path: {{ $server.ssePath | quote }}
        {{- end }}
      {{- end }}
{{- end }}