# Default values for apa.
# This is a YAML-formatted file.
# Declare variables to be passed into your templates.

# Global values
global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: ""

nameOverride: ""
fullnameOverride: ""

# Backend API configuration
backend:
  enabled: true
  replicaCount: 1

  image:
    repository: apa/apa-backend
    pullPolicy: IfNotPresent
    # Overrides the image tag whose default is the chart appVersion.
    tag: ""

  serviceAccount:
    # Specifies whether a service account should be created
    create: true
    # Annotations to add to the service account
    annotations: {}
    # The name of the service account to use.
    name: ""

  # Pod annotations
  podAnnotations: {}

  # Pod labels
  podLabels: {}

  # Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534

  # Container security context
  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 65534

  service:
    type: ClusterIP
    port: 80
    targetPort: 8000
    annotations: {}

  ingress:
    enabled: false
    className: "nginx"
    annotations: {}
      # cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - host: apa-api.example.com
        paths:
          - path: /
            pathType: Prefix
    tls: []
    #  - secretName: apa-api-tls
    #    hosts:
    #      - apa-api.example.com

  resources:
    limits:
      cpu: 1000m
      memory: 2Gi
    requests:
      cpu: 500m
      memory: 1Gi

  # Autoscaling configuration
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 5
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}

  # Environment variables
  env:
    CORS_ORIGINS: "*"
    LOG_LEVEL: "INFO"
    UVICORN_HOST: "0.0.0.0"
    UVICORN_PORT: "8000"
    UVICORN_APP: "apa.server.main:app"
    # Default LLM model for AI operations
    # This setting controls which LLM model is used by default for process and service agents
    # Valid options:
    # - OpenAI models: "gpt-4o-mini", "gpt-4o", "gpt-4-turbo"
    # - Anthropic models: "anthropic:claude-3-5-sonnet-20241022", "anthropic:claude-sonnet-4-20250514"
    # - Custom models: Any model supported by your configured LLM provider
    # Note: Ensure you have the appropriate API keys configured for the chosen provider
    DEFAULT_LLM_MODEL: "anthropic:claude-sonnet-4-20250514"
    # Desktop MCP server URL (defaults to host.docker.internal:8001 if not set)
    DESKTOP_MCP_URL: ""

  # Environment from sources
  envFrom: []
  #  - secretRef:
  #      name: apa-backend-secrets
  #  - configMapRef:
  #      name: apa-backend-config

  # Health checks
  livenessProbe:
    httpGet:
      path: /internal/liveness
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1

  readinessProbe:
    httpGet:
      path: /internal/readiness
      port: http
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
    successThreshold: 1

  # Volume mounts
  volumeMounts: []

  # Volumes
  volumes: []

# Frontend configuration
frontend:
  enabled: true
  replicaCount: 1

  image:
    repository: apa/apa-frontend
    pullPolicy: IfNotPresent
    tag: ""

  serviceAccount:
    create: true
    annotations: {}
    name: ""

  podAnnotations: {}
  podLabels: {}

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534

  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 65534

  service:
    type: ClusterIP
    port: 80
    targetPort: 8080
    annotations: {}

  ingress:
    enabled: true
    className: "nginx"
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - host: apa.example.com
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: apa-frontend-tls
        hosts:
          - apa.example.com

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80

  nodeSelector: {}
  tolerations: []
  affinity: {}

  # Environment variables - will be injected at build time for Vite
  env:
    VITE_BACKEND_URL: "https://apa-api.example.com"

  livenessProbe:
    httpGet:
      path: /
      port: http
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1

  readinessProbe:
    httpGet:
      path: /
      port: http
    initialDelaySeconds: 5
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
    successThreshold: 1

  volumeMounts: []
  volumes: []

# Network policies
networkPolicy:
  enabled: false
  # Allow traffic only from backend to database
  database:
    allowedPods:
      - namespaceSelector:
          matchLabels:
            name: agentic-process-automation
        podSelector:
          matchLabels:
            app.kubernetes.io/name: apa
            app.kubernetes.io/component: backend

# Service Monitor for Prometheus
serviceMonitor:
  enabled: false
  interval: 30s
  path: /metrics
  labels: {}

# Pod Disruption Budget
podDisruptionBudget:
  enabled: false
  minAvailable: 1
  # maxUnavailable: 1

# Desktop Use MCP server configuration
desktopUse:
  enabled: false
  replicaCount: 1  # Single replica for stateful WebSocket connections

  image:
    repository: apa/apa-desktop-use
    pullPolicy: IfNotPresent
    tag: ""

  serviceAccount:
    # Specifies whether a service account should be created
    create: true
    # Annotations to add to the service account
    annotations: {}
    # The name of the service account to use
    name: ""

  # Pod annotations
  podAnnotations: {}

  # Pod labels
  podLabels: {}

  # Pod security context
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534

  # Container security context
  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 65534

  service:
    type: ClusterIP
    ports:
      mcp:
        port: 8001
        targetPort: 8001
      websocket:
        port: 8002
        targetPort: 8002
    annotations: {}

  ingress:
    enabled: false
    className: "nginx"
    annotations:
      # WebSocket support
      nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "30"
    hosts:
      - host: apa-desktop-ws.example.com
        paths:
          - path: /
            pathType: Prefix
    tls: []

  resources:
    limits:
      cpu: 500m
      memory: 1Gi
    requests:
      cpu: 250m
      memory: 512Mi

  # Health checks
  livenessProbe:
    httpGet:
      path: /health
      port: mcp
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1

  readinessProbe:
    httpGet:
      path: /health
      port: mcp
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
    successThreshold: 1

  # Environment variables
  env: {}

  # Environment from sources
  envFrom: []

  # Node selector
  nodeSelector: {}

  # Tolerations
  tolerations: []

  # Affinity
  affinity: {}

  # Volume mounts
  volumeMounts: []

  # Volumes
  volumes: []
# Bitnami PostgreSQL subchart configuration
postgresql:
  enabled: true
  auth:
    username: apa
    database: apa
    # IMPORTANT: Create a secret named 'postgresql-secret' with keys 'password' and 'postgres-password'
    # See README.md for instructions
    existingSecret: "postgresql-secret"
    secretKeys:
      adminPasswordKey: "postgres-password"
      userPasswordKey: "password"
  primary:
    persistence:
      enabled: true
      size: 10Gi
      # storageClass: "-"
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 100m
        memory: 256Mi
    initdb:
      scripts:
        init.sql: |
          CREATE EXTENSION IF NOT EXISTS vector;
          GRANT ALL PRIVILEGES ON DATABASE apa TO apa;
  # PostgreSQL configuration
  postgresqlExtendedConf:
    shared_preload_libraries: "vector"
    max_connections: "200"
  # Metrics
  metrics:
    enabled: false

# Agent Gateway configuration
# @schema title: "Agent Gateway"
# @schema description: "Configuration for the Agent Gateway controller that manages MCP servers"
agentGateway:
  # @schema title: "Enable Agent Gateway"
  # @schema description: "Enable the Agent Gateway deployment"
  # @schema type: boolean
  # @schema default: false
  enabled: false
  # @schema title: "Replica Count"
  # @schema description: "Number of Agent Gateway replicas (should be 1 for controller)"
  # @schema type: integer
  # @schema minimum: 1
  # @schema default: 1
  replicaCount: 1  # Single replica for controller

  # @schema title: "Image Configuration"
  # @schema description: "Container image configuration for Agent Gateway"
  image:
    # @schema title: "Repository"
    # @schema description: "Docker image repository"
    # @schema type: string
    # @schema default: "apa/apa-agent-gateway"
    repository: apa/apa-agent-gateway
    # @schema title: "Pull Policy"
    # @schema description: "Image pull policy"
    # @schema type: string
    # @schema enum: ["Always", "IfNotPresent", "Never"]
    # @schema default: "IfNotPresent"
    pullPolicy: IfNotPresent
    # @schema title: "Tag"
    # @schema description: "Image tag (defaults to chart appVersion)"
    # @schema type: string
    tag: ""

  # @schema title: "Service Account"
  # @schema description: "Service account configuration"
  serviceAccount:
    # @schema title: "Create Service Account"
    # @schema description: "Specifies whether a service account should be created"
    # @schema type: boolean
    # @schema default: true
    create: true
    # @schema title: "Annotations"
    # @schema description: "Annotations to add to the service account"
    # @schema type: object
    annotations: {}
    # @schema title: "Name"
    # @schema description: "The name of the service account to use"
    # @schema type: string
    name: ""

  # @schema title: "Pod Annotations"
  # @schema description: "Annotations to add to the pod"
  # @schema type: object
  podAnnotations: {}

  # @schema title: "Pod Labels"
  # @schema description: "Additional labels to add to the pod"
  # @schema type: object
  podLabels: {}

  # @schema title: "Pod Security Context"
  # @schema description: "Security context for the pod"
  # @schema type: object
  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534

  # @schema title: "Container Security Context"
  # @schema description: "Security context for the container"
  # @schema type: object
  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 65534

  # @schema title: "Service Configuration"
  # @schema description: "Kubernetes Service configuration"
  service:
    # @schema title: "Service Type"
    # @schema description: "Type of Kubernetes Service"
    # @schema type: string
    # @schema enum: ["ClusterIP", "NodePort", "LoadBalancer"]
    # @schema default: "ClusterIP"
    type: ClusterIP
    # @schema title: "Port"
    # @schema description: "Service port"
    # @schema type: integer
    # @schema minimum: 1
    # @schema maximum: 65535
    # @schema default: 8080
    port: 8080
    # @schema title: "Annotations"
    # @schema description: "Annotations for the service"
    # @schema type: object
    annotations: {}

  # @schema title: "Resources"
  # @schema description: "Resource limits and requests"
  # @schema type: object
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # @schema title: "Liveness Probe"
  # @schema description: "Liveness probe configuration"
  # @schema type: object
  livenessProbe:
    httpGet:
      path: /live
      port: http
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
    successThreshold: 1

  # @schema title: "Readiness Probe"
  # @schema description: "Readiness probe configuration"
  # @schema type: object
  readinessProbe:
    httpGet:
      path: /ready
      port: http
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3
    successThreshold: 1

  # @schema title: "Environment Variables"
  # @schema description: "Environment variables for the container"
  # @schema type: object
  # @schema additionalProperties: {"type": "string"}
  env: {}

  # @schema title: "Environment From"
  # @schema description: "List of sources to populate environment variables"
  # @schema type: array
  # @schema itemRef: $k8s/_definitions.json#/definitions/io.k8s.api.core.v1.EnvFromSource
  envFrom: []
  #  - secretRef:
  #      name: agent-gateway-secrets
  #  - configMapRef:
  #      name: agent-gateway-config

  # @schema title: "Node Selector"
  # @schema description: "Node selector for pod assignment"
  # @schema type: object
  # @schema additionalProperties: {"type": "string"}
  nodeSelector: {}

  # @schema title: "Tolerations"
  # @schema description: "Tolerations for pod assignment"
  # @schema type: array
  # @schema itemRef: $k8s/_definitions.json#/definitions/io.k8s.api.core.v1.Toleration
  tolerations: []

  # @schema title: "Affinity"
  # @schema description: "Affinity rules for pod assignment"
  # @schema $ref: $k8s/_definitions.json#/definitions/io.k8s.api.core.v1.Affinity
  affinity: {}

  # @schema title: "Volume Mounts"
  # @schema description: "Additional volume mounts for the container"
  # @schema type: array
  # @schema itemRef: $k8s/_definitions.json#/definitions/io.k8s.api.core.v1.VolumeMount
  volumeMounts: []

  # @schema title: "Volumes"
  # @schema description: "Additional volumes for the pod"
  # @schema type: array
  # @schema itemRef: $k8s/_definitions.json#/definitions/io.k8s.api.core.v1.Volume
  volumes: []

  # @schema title: "Logging Configuration"
  # @schema description: "Logging configuration for the Agent Gateway"
  logging:
    # @schema title: "Log Level"
    # @schema description: "Logging level for the application"
    # @schema type: string
    # @schema enum: ["debug", "info", "warn", "error"]
    # @schema default: "info"
    level: "info"
    # @schema title: "Log Format"
    # @schema description: "Format for log output"
    # @schema type: string
    # @schema enum: ["text", "json"]
    # @schema default: "json"
    format: "json"

  # @schema title: "Observability Configuration"
  # @schema description: "OpenTelemetry observability configuration"
  observability:
    # @schema title: "Metrics Exporter"
    # @schema description: "OpenTelemetry metrics exporter type"
    # @schema type: string
    # @schema enum: ["prometheus", "otlp", "none"]
    # @schema default: "prometheus"
    metricsExporter: "prometheus"
    # @schema title: "Traces Exporter"
    # @schema description: "OpenTelemetry traces exporter type"
    # @schema type: string
    # @schema enum: ["otlp", "none"]
    # @schema default: "none"
    tracesExporter: "none"
    # @schema title: "OTLP Endpoint"
    # @schema description: "OpenTelemetry Protocol (OTLP) collector endpoint"
    # @schema type: string
    # @schema default: ""
    # @schema examples: ["localhost:4317", "otel-collector.monitoring:4317"]
    otlpEndpoint: ""  # e.g., "localhost:4317"

  # @schema title: "Agent Gateway Configuration"
  # @schema description: "Configuration for the Agent Gateway application"
  config:
    # @schema title: "MCP Server TTL"
    # @schema description: "Time-to-live for MCP servers. If set, Jobs will be used instead of Deployments"
    # @schema type: string
    # @schema pattern: "^[0-9]+(s|m|h)$"
    # @schema examples: ["30m", "1h", "24h"]
    # mcpServerTTL: "1h"

    # @schema title: "MCP Server Definitions"
    # @schema description: "Configuration for MCP servers managed by the gateway"
    # @schema type: object
    # @schema additionalProperties: {"type": "object"}
    mcpServers: {}
      # Example dynamic MCP server (managed by agent gateway)
      # desktop-use:
      #   image: "apa/apa-desktop-use:latest"
      #   port: 8001
      #   mcpPath: "/mcp"
      #   ssePath: "/sse"
      #   env:
      #     LOG_LEVEL: "info"
      #   resources:
      #     limits:
      #       cpu: 500m
      #       memory: 1Gi
      #     requests:
      #       cpu: 250m
      #       memory: 512Mi

      # Example static MCP server (external service)
      # playwright-mcp:
      #   staticUrl: "http://playwright-mcp.external-namespace:8931"
      #   mcpPath: "/mcp"
      #   ssePath: "/sse"

# Evaluator Service configuration
evaluator:
  enabled: false
  replicaCount: 1  # Single replica for background service

  image:
    repository: apa/apa-evaluator
    pullPolicy: IfNotPresent
    tag: ""

  serviceAccount:
    create: true
    annotations: {}
    name: ""

  podAnnotations: {}
  podLabels: {}

  podSecurityContext:
    runAsNonRoot: true
    runAsUser: 65534
    fsGroup: 65534

  securityContext:
    capabilities:
      drop:
        - ALL
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 65534

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 100m
      memory: 128Mi

  # Autoscaling configuration
  autoscaling:
    enabled: false
    minReplicas: 1
    maxReplicas: 3
    targetCPUUtilizationPercentage: 80
    targetMemoryUtilizationPercentage: 80

  nodeSelector: {}
  tolerations: []
  affinity: {}

  # Environment variables
  env:
    LOG_LEVEL: "INFO"
    # DEFAULT_LLM_MODEL should be set to match backend for consistency
    DEFAULT_LLM_MODEL: "anthropic:claude-sonnet-4-20250514"
    # Langfuse configuration - credentials should be provided via envFrom secrets
    # LANGFUSE_HOST: "https://cloud.langfuse.com"
    # LANGFUSE_PUBLIC_KEY: "" # Set via secret
    # LANGFUSE_SECRET_KEY: "" # Set via secret

  # Environment from sources - use secrets for Langfuse credentials
  envFrom: []
  #  - secretRef:
  #      name: evaluator-secrets
  #      # Should contain: LANGFUSE_HOST, LANGFUSE_PUBLIC_KEY, LANGFUSE_SECRET_KEY

  volumeMounts: []
  volumes: []
