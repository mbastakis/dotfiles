# Istio Deployment Checklist

## Pre-Deployment Tasks

- [ ] **Review Implementation Guide**
  - Read `/Users/mbastakis/dev/work/docs/istio-implementation-guide.md`
  - Understand component dependencies
  - Review configuration changes

- [ ] **Create GitLab Repository for istio-cni-helm**
  - Navigate to: https://gitlab.devops.telekom.de/aicc/infrastructure/argocd/helm-charts
  - Create new repository: `istio-cni-helm`
  - Set appropriate permissions
  - Note the repository URL

## Helm Chart Deployment

### 1. Push istio-cni-helm to GitLab

```bash
cd /Users/mbastakis/dev/work/aicc-group/infrastructure/argocd/helm-charts/istio-cni-helm

# Initialize git if not already done
git init
git add .
git commit -m "Initial commit: Istio CNI helm chart v1.26.3"

# Add remote (replace with actual URL)
git remote add origin https://gitlab.devops.telekom.de/aicc/infrastructure/argocd/helm-charts/istio-cni-helm.git

# Push to main branch
git branch -M main
git push -u origin main
```

### 2. Update istio-base-helm

```bash
cd /Users/mbastakis/dev/work/aicc-group/infrastructure/argocd/helm-charts/istio-base-helm

git add .
git commit -m "Upgrade to Istio 1.26.3"
git push
```

### 3. Update istiod-helm (CRITICAL - CNI enabled)

```bash
cd /Users/mbastakis/dev/work/aicc-group/infrastructure/argocd/helm-charts/istiod-helm

git add .
git commit -m "Upgrade to Istio 1.26.3 and enable CNI plugin"
git push
```

### 4. Update istio-ingressgateway-helm

```bash
cd /Users/mbastakis/dev/work/aicc-group/infrastructure/argocd/helm-charts/istio-ingressgateway-helm

git add .
git commit -m "Upgrade to Istio 1.26.3"
git push
```

## ArgoCD Application Deployment

### 5. Push ArgoCD Application Manifests

```bash
cd /Users/mbastakis/dev/work/aicc-group/infrastructure/argocd/dev-core-kubernetes-infra-app-of-apps

# Review changes
git status
git diff

# Commit changes
git add istio-base.yaml istio-cni.yaml istiod.yaml istio-ingressgateway.yaml
git commit -m "Add Istio CNI and sync waves for proper deployment order"
git push
```

## Deployment Monitoring

### 6. Monitor ArgoCD Sync

```bash
# Watch ArgoCD applications
watch -n 2 'kubectl get applications -n argocd | grep istio'

# Expected progression:
# 1. istio-base: Synced, Healthy (Wave 0)
# 2. istio-cni: Synced, Healthy (Wave 1)
# 3. istiod: Synced, Healthy (Wave 2)
# 4. istio-ingressgateway: Synced, Healthy (Wave 3)
```

### 7. Verify Pod Deployments

```bash
# Check istio-system namespace
kubectl get pods -n istio-system

# Expected pods:
# - istio-cni-node-xxxxx (DaemonSet - one per node)
# - istiod-xxxxx-xxxxx (3 replicas)

# Check istio-ingress namespace
kubectl get pods -n istio-ingress

# Expected pods:
# - istio-ingressgateway-xxxxx-xxxxx (3 replicas)
```

### 8. Verify CNI Installation

```bash
# Check CNI DaemonSet
kubectl get daemonset -n istio-system istio-cni-node

# Verify CNI is running on all nodes
kubectl get nodes
# Compare node count with DaemonSet DESIRED/CURRENT/READY

# Check CNI logs for any errors
kubectl logs -n istio-system ds/istio-cni-node --tail=50
```

### 9. Verify istiod Configuration

```bash
# Check istiod replicas (should be 3)
kubectl get deploy -n istio-system istiod

# Verify CNI is enabled in istiod
kubectl get cm -n istio-system istio -o yaml | grep -i cni

# Check istiod logs
kubectl logs -n istio-system -l app=istiod --tail=50
```

### 10. Verify Ingress Gateway

```bash
# Check ingress gateway service
kubectl get svc -n istio-ingress

# Check NLB creation in AWS
aws elbv2 describe-load-balancers --region eu-central-1 | grep istio-dev-nlb

# Verify gateway is healthy
kubectl get pods -n istio-ingress -l app=istio-ingressgateway
```

## Post-Deployment Validation

### 11. Test Service Mesh Injection

```bash
# Create test namespace with injection enabled
kubectl create namespace istio-test
kubectl label namespace istio-test istio-injection=enabled

# Deploy test application
kubectl apply -f - <<EOF
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-app
  namespace: istio-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: test-app
  template:
    metadata:
      labels:
        app: test-app
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80
EOF

# Verify sidecar injection (should show 2/2 containers)
kubectl get pods -n istio-test

# Check pod has istio-proxy sidecar
kubectl describe pod -n istio-test -l app=test-app | grep -i "istio-proxy"
```

### 12. Verify mTLS

```bash
# Check if mTLS is working
kubectl exec -n istio-test deploy/test-app -c istio-proxy -- pilot-agent request GET stats | grep tls

# Verify TLS version (should show TLSv1.3)
kubectl exec -n istio-test deploy/test-app -c istio-proxy -- pilot-agent request GET config_dump | grep -i "min_protocol_version"
```

### 13. Check Istio Metrics

```bash
# Verify Prometheus metrics are exposed
kubectl exec -n istio-system deploy/istiod -- curl -s localhost:15014/metrics | head -20

# Check if metrics are being collected
kubectl exec -n istio-test deploy/test-app -c istio-proxy -- curl -s localhost:15020/stats/prometheus | head -20
```

## Cleanup Test Resources

```bash
# Remove test namespace
kubectl delete namespace istio-test
```

## Rollback Plan (If Needed)

If issues occur during deployment:

### Option 1: Rollback ArgoCD Applications

```bash
# Sync to previous version
argocd app history istio-cni
argocd app rollback istio-cni <REVISION>

argocd app history istiod
argocd app rollback istiod <REVISION>
```

### Option 2: Manual Intervention

```bash
# Disable auto-sync temporarily
argocd app set istio-cni --sync-policy none
argocd app set istiod --sync-policy none

# Investigate and fix issues
kubectl logs -n istio-system -l app=istiod
kubectl logs -n istio-system ds/istio-cni-node

# Re-enable auto-sync after fixes
argocd app set istio-cni --sync-policy automated
argocd app set istiod --sync-policy automated
```

## Success Criteria

Deployment is successful when:

- [ ] All ArgoCD applications show: **Synced, Healthy**
- [ ] CNI DaemonSet running on all nodes (DESIRED = CURRENT = READY)
- [ ] istiod has 3 running replicas
- [ ] istio-ingressgateway has 3 running replicas
- [ ] Test pod gets sidecar injection (2/2 containers)
- [ ] mTLS is working (TLSv1.3)
- [ ] No error logs in istio components
- [ ] AWS NLB created and healthy

## Troubleshooting Reference

If issues occur, refer to:
- `/Users/mbastakis/dev/work/docs/istio-implementation-guide.md` (Troubleshooting section)
- Istio official documentation: https://istio.io/latest/docs/ops/diagnostic-tools/
- ArgoCD UI: Check application sync status and logs

## Completion

- [ ] All checklist items completed
- [ ] Documentation updated with any deviations
- [ ] Team notified of deployment completion
- [ ] Monitoring dashboards configured

---

**Checklist Version**: 1.0
**Date**: October 21, 2025
