################################################################################
# EKS
################################################################################

module "eks" {
  source = "./modules/eks-cluster"

  create_eks   = true
  cluster_name = var.cluster_name

  tags = {
    team         = "plattform team"
    managed      = "terraform"
    "dtit:sec:InfoSecClass" = "internal"
    "dtit:sec:NetworkLayer" = "Application"
  }
  cluster_security_group_additional_rules = {
    internet = {
      type        = "egress"
      from_port   = 0
      to_port     = 0
      protocol    = "-1"
      cidr_blocks = ["0.0.0.0/0"]
      description = "Allow cluster egress access to the Internet"
    }

    # Allow EKS control plane to reach webhook services on worker nodes
    # Required for Istio admission webhooks (sidecar injection, validation)
    # and other admission controllers (cert-manager, etc.)
    webhook_ingress = {
      type                     = "ingress"
      from_port                = 443
      to_port                  = 65535
      protocol                 = "tcp"
      source_cluster_security_group = true
      description              = "Allow control plane to reach webhook services (Istio, cert-manager, etc.)"
    }
  }
  admin_users           = var.admin_users
  namespace_user_groups = var.namespace_user_groups

  vpc_id             = data.aws_vpc.vpc_shared.id
  private_subnet_ids = data.aws_subnets.private_subnet_shared.ids
}

#################################################################################
# Storage Classes
#################################################################################

module "storage-classes" {
  source     = "./modules/storage-classes"
  depends_on = [module.eks]
}

################################################################################
# SOPS Configuration
################################################################################
module "sops" {
  source            = "./modules/sops"
  cluster_name      = var.cluster_name
  depends_on        = [module.eks]
  oidc_provider_arn = module.eks.oidc_provider_arn

}