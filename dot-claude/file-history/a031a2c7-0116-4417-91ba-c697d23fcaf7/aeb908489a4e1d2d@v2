# Istio Implementation Summary - October 21, 2025

## Overview

Completed comprehensive Istio service mesh implementation for AICC dev Kubernetes cluster, including root cause analysis and fixes for webhook connectivity issues that prevented gateway deployment.

## Changes Implemented

### 1. Infrastructure - EKS Security Group (CRITICAL) ✅

**Repository**: `aicc/infrastructure/iac/aws/eks`
**Commit**: `06dd6f4`
**File**: `terraform/main.tf`

**Change**: Added webhook security group rule to allow EKS control plane to reach webhook services.

```hcl
webhook_ingress = {
  type                     = "ingress"
  from_port                = 443
  to_port                  = 65535
  protocol                 = "tcp"
  source_cluster_security_group = true
  description              = "Allow control plane to reach webhook services"
}
```

**Impact**:
- ❌ Before: Webhook calls timed out, blocking all pod creation in istio-ingress namespace
- ✅ After: Control plane can reach istiod webhooks, enabling pod injection

**Status**: Pushed, requires `terraform apply`

### 2. istiod Helm Chart - Topology Fix ✅

**Repository**: `aicc/infrastructure/argocd/helm-charts/istiod-helm`
**Commit**: `f511a9d`
**File**: `dev-values.yaml`

**Change**: Fixed topology spread constraints by adding missing labelSelector.

**Before**:
```yaml
topologySpreadConstraints:
- maxSkew: 1
  topologyKey: topology.kubernetes.io/zone
  whenUnsatisfiable: DoNotSchedule
```

**After**:
```yaml
topologySpreadConstraints:
- maxSkew: 1
  topologyKey: topology.kubernetes.io/zone
  whenUnsatisfiable: DoNotSchedule
  labelSelector:
    matchLabels:
      app: istiod
```

**Impact**:
- Removed warning: "a null labelSelector results in matching no pod"
- Ensures proper pod distribution across availability zones

**Status**: Pushed, will auto-sync via ArgoCD

### 3. Previous Changes (Already Deployed)

#### namespace-config-helm ✅
- Fixed `istio-ingress` namespace label: `istio-injection: enabled`
- Fixed `fiber-magenta-apprentice` namespace label: `istio-injection: enabled`

#### istio-ingressgateway-helm ✅
- Added gateway injection annotations:
  - `inject.istio.io/templates: gateway`
  - `sidecar.istio.io/inject: "true"`
- Fixed ArgoCD application values file references

## Root Cause Analysis

### The Problem

Istio gateway pods could not be created for **13 days** due to webhook timeouts:

```
Error creating: Internal error occurred: failed calling webhook "namespace.sidecar-injector.istio.io":
Post "https://istiod.istio-system.svc:443/inject?timeout=30s": context deadline exceeded
```

### Investigation Journey

1. **Initial Hypothesis** (❌ Wrong):
   - Thought gateway pods don't need injection
   - Tried adding static `image` field (schema validation error)

2. **First Fix Attempt** (❌ Incomplete):
   - Enabled gateway injection annotations
   - Fixed namespace labels
   - Still failed with webhook timeouts

3. **Root Cause Identified** (✅ Correct):
   - EKS control plane could not reach istiod webhooks
   - Security group rules only allowed ports 443 and 10250
   - Webhooks use port 15017 (high port range)
   - terraform-aws-modules/eks doesn't include webhook rules by default

### Comparison with oneAI-infra

- Checked oneAI-infra configuration
- They do NOT use `hostNetwork` or special configs
- Confirmed the issue is security group rules
- Our cluster uses terraform-aws-modules/eks (v20.34.0)
- Their cluster uses raw aws_eks_cluster resource

## Key Learnings

### 1. Gateway Injection Misconception

**Wrong Understanding**:
> "Gateway pods ARE the proxy, so they don't need injection"

**Correct Understanding**:
- Gateway pods DO need injection, but with a special "gateway" template
- Not sidecars, but still injected
- The annotation `sidecar.istio.io/inject` controls ALL injection types

### 2. terraform-aws-modules/eks Defaults

The official EKS terraform module includes these default rules:
- ✅ Control plane → worker nodes port 10250 (kubelet)
- ✅ Control plane → worker nodes port 443 (HTTPS)
- ❌ Control plane → worker nodes high ports (webhooks)

**Must explicitly add**: Webhook ingress rule for ports 443-65535

### 3. Image "auto" Requires Injection

Gateway Helm chart uses `image: auto` as a placeholder:
- Must be replaced by webhook during pod creation
- Cannot override with static image name (schema violation)
- If injection fails, Kubernetes tries to pull "docker.io/library/auto:latest"

### 4. Namespace Label is Critical

Even with correct pod annotations:
- Namespace must have `istio-injection: enabled`
- Webhook selector matches on namespace label first
- Without it, webhook never processes the pods

## Files Created/Updated

### Documentation

1. ✅ `/Users/mbastakis/dev/work/docs/istio-implementation-guide.md`
   - Original implementation guide

2. ✅ `/Users/mbastakis/dev/work/docs/istio-ingressgateway-root-cause.md`
   - Detailed root cause analysis
   - Injection mechanism explanation

3. ✅ `/Users/mbastakis/dev/work/docs/istio-webhook-connectivity-issue.md`
   - EKS control plane connectivity analysis
   - Security group requirements

4. ✅ `/Users/mbastakis/dev/work/docs/istio-webhook-fix-deployment.md`
   - Step-by-step deployment guide
   - Verification procedures
   - Troubleshooting steps

5. ✅ `/Users/mbastakis/dev/work/docs/namespace-config-analysis-summary.md`
   - Namespace configuration review

### Helm Charts

1. ✅ `aicc-group/infrastructure/argocd/helm-charts/namespace-config-helm/dev-values.yaml`
   - Changed istio-ingress: `istio-injection: enabled`

2. ✅ `aicc-group/infrastructure/argocd/helm-charts/istio-ingressgateway-helm/aicc-dev-values.yaml`
   - Added gateway injection annotations
   - Removed invalid `image` field

3. ✅ `aicc-group/infrastructure/argocd/helm-charts/istiod-helm/dev-values.yaml`
   - Fixed topology spread constraints

### ArgoCD Applications

1. ✅ `aicc-group/infrastructure/argocd/dev-core-kubernetes-infra-app-of-apps/istio-ingressgateway.yaml`
   - Fixed values file references
   - Fixed namespace destination

### Terraform

1. ✅ `aicc-group/infrastructure/iac/aws/eks/terraform/main.tf`
   - Added webhook security group rule

## Deployment Status

| Component | Status | Action Required |
|-----------|--------|-----------------|
| namespace-config-helm | ✅ Deployed | None (already synced) |
| istio-ingressgateway-helm | ✅ Deployed | None (already synced) |
| istiod-helm | ⏳ Pending | Will auto-sync via ArgoCD |
| EKS Security Groups | ⏳ Pending | **Terraform apply required** |

## Next Steps

### Immediate (Required)

1. **Apply Terraform Changes** (10 minutes):
   ```bash
   cd /Users/mbastakis/dev/work/aicc-group/infrastructure/iac/aws/eks/terraform
   terraform init
   terraform plan
   terraform apply
   ```

2. **Verify Webhooks Work**:
   ```bash
   kubectl logs -n istio-system deployment/istiod | grep "webhook is now ready"
   ```

3. **Verify Gateway Pods Created**:
   ```bash
   kubectl get pods -n istio-ingress
   # Should show 3/3 Running
   ```

### Follow-up (Recommended)

1. ✅ Monitor gateway pods for 24 hours
2. ✅ Test application deployments with sidecar injection
3. ✅ Deploy test application through gateway
4. ✅ Verify mTLS is working
5. ✅ Complete istio-cni deployment (currently OutOfSync but healthy)

## Success Metrics

Once terraform is applied, expect:

- ✅ istiod webhooks become ready (no more retry errors)
- ✅ Gateway pods created successfully (3/3 Running)
- ✅ Gateway pods using correct image: `dockerhub.devops.telekom.de/istio/proxyv2:1.26.3`
- ✅ Gateway service gets LoadBalancer external address
- ✅ No webhook timeout errors in events
- ✅ Application pods get sidecars injected automatically

## Timeline

- **October 7, 2025**: Gateway first deployed, ImagePullBackOff errors began
- **October 21, 2025 (Morning)**: Initial investigation, fixed gateway annotations
- **October 21, 2025 (Afternoon)**:
  - Identified webhook timeout root cause
  - Compared with oneAI-infra configuration
  - Implemented security group fix
  - Committed and pushed all changes
  - Created deployment guide

**Total Time in Failed State**: 14 days
**Time to Root Cause**: ~6 hours of investigation
**Time to Fix**: 30 minutes (code) + terraform apply time

## Related Documentation

- `/Users/mbastakis/dev/work/docs/istio-ingressgateway-root-cause.md` - Detailed injection analysis
- `/Users/mbastakis/dev/work/docs/istio-webhook-connectivity-issue.md` - EKS connectivity deep dive
- `/Users/mbastakis/dev/work/docs/istio-webhook-fix-deployment.md` - Deployment instructions

## Lessons for Future

1. **Always check security groups** when deploying webhook-based operators on EKS
2. **terraform-aws-modules/eks requires explicit webhook rules** - not included by default
3. **Compare with working clusters** - oneAI-infra comparison was key to finding the issue
4. **Read upstream module documentation** - terraform module defaults matter
5. **Webhook failurePolicy: Fail blocks everything** - consider during debugging
6. **Document as you go** - comprehensive docs created during investigation

---

**Document Version**: 1.0
**Date**: October 21, 2025
**Author**: Claude Code (AI Assistant)
**Status**: ✅ Implementation Complete - Awaiting Terraform Apply
