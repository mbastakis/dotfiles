stages:
  - test
  - build
  - release

# Include reusable templates from cicd-templates
include:
  - project: aicc/infrastructure/cicd-templates
    ref: main
    file: pipeline_templates/docker/docker-build.yml
  - project: aicc/infrastructure/cicd-templates
    ref: main
    file: pipeline_templates/mtr/login-mtr.yml

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: "tcp://docker:2375"
  BACKEND_DIR: "backend"
  FRONTEND_DIR: "frontend"
  ARTIFACTORY_TOKEN: ""
  ARTIFACTORY_USER: ""
  PYPI_INDEX_URL: https://${ARTIFACTORY_USER}:${ARTIFACTORY_TOKEN}@artifactory.devops.telekom.de/artifactory/api/pypi/aicc-pypi-virtual/simple
  # MTR Registry Configuration
  MTR_REGISTRY: ${MTR_REGISTRY:-mtr.devops.telekom.de}
  MTR_PROJECT_PATH: aicc-llm-assistant/magenta-apprentice

# ================================
# PYTHON TEST JOBS
# ================================

.python_job:
  image: python:3.12.11@sha256:645df645815f1403566b103b2a2bb07f6a01516bbb15078ed004e41d198ba194
  variables:
    UV_CACHE_DIR: .cache/pip
    PIP_CACHE_DIR: .cache/uv
    PYLINTHOME: .cache/pylint
    PYRIGHT_PYTHON_CACHE_DIR: .cache/pyright
    UV_INDEX_ARTIFACTORY_USERNAME: $ARTIFACTORY_USER
    UV_INDEX_ARTIFACTORY_PASSWORD: $ARTIFACTORY_TOKEN
  before_script:
    - chown -R $(whoami) .cache || echo no cache
    - mkdir -p artifacts/
    - python3 -m pip install -q uv
    - cd $BACKEND_DIR
    - export UV_CACHE_DIR=../$UV_CACHE_DIR
    - export PYLINTHOME=../$PYLINTHOME
    - export PYRIGHT_PYTHON_CACHE_DIR=../$PYRIGHT_PYTHON_CACHE_DIR
    - uv sync --group dev
  after_script:
    - mv $BACKEND_DIR/uv.lock artifacts || true
  artifacts:
    paths:
      - ./artifacts/
    expire_in: 1 weeks
  cache:
    - key:
        files:
          - $BACKEND_DIR/pyproject.toml
      fallback_keys:
        - cache-$CI_COMMIT_BRANCH
      paths:
        - .cache/pip
        - .cache/uv
        - .cache/pytest
        - .cache/pylint
        - .cache/pyright
  interruptible: true
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH
      changes:
        compare_to: 'refs/heads/main'
        paths:
          - $BACKEND_DIR/**
      when: always
    - if: $CI_COMMIT_BRANCH
      when: manual
  allow_failure: true

py_test:
  stage: test
  extends: .python_job
  variables:
    POSTGRES_USER: apa
    POSTGRES_PASSWORD: apa_password
    POSTGRES_DB: apa
    PGDATABASE: $POSTGRES_DB
    PGHOST: "postgres"
    PGPASSWORD: $POSTGRES_PASSWORD
    PGDATABASEL: $POSTGRES_DB
    PGUSER: $POSTGRES_USER
    DEFAULT_LLM_MODEL: anthropic:claude-sonnet-4-20250514
  services:
    - name: pgvector/pgvector:pg17
      alias: postgres
  script:
    - uv run --frozen --active pytest -o cache_dir=../.cache/pytest --cov-branch --cov-report term --cov-report html:../artifacts --cov-fail-under=75 --cov=src/apa/

py_lint:
  stage: test
  extends: .python_job
  script:
    - uv -q sync --only-group dev --active
    - uv -q run --active --frozen ruff check
    - uv -q run --active --frozen pyright
    - uv -q run --active --frozen typos

# ================================
# NODE TEST JOBS
# ================================

.node_job:
  image: node:22-alpine
  before_script:
    - cd $FRONTEND_DIR
    - mkdir -p artifacts/
    - npm config set cache $NPM_CACHE --global
    - npm ci --include dev
  cache:
    - key:
        files:
          - $FRONTEND_DIR/package.json
      fallback_keys:
        - cache-$CI_COMMIT_BRANCH
      paths:
        - .cache/npm
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH
      changes:
        compare_to: 'refs/heads/main'
        paths:
          - $FRONTEND_DIR/**
      when: always
    - if: $CI_COMMIT_BRANCH
      when: manual
  allow_failure: true

ts_lint:
  stage: test
  extends: .node_job
  interruptible: true
  script: ["npm run lint"]

# ================================
# BUILD JOBS (Using Kaniko)
# ================================

# Backend Build - Push to MTR
build_backend:
  stage: build
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "backend"
    DOCKERFILE_PATH: "backend/Dockerfile"
    ADDITIONAL_BUILD_ARGS: "--build-arg UV_INDEX_URL=${PYPI_INDEX_URL}"
  needs:
    - py_test
    - py_lint
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH
      when: manual

# Frontend Build - Push to MTR
build_frontend:
  stage: build
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "frontend"
    DOCKERFILE_PATH: "frontend/Dockerfile.prod"
  needs:
    - ts_lint
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH
      when: manual

# Agent Gateway Build - Push to MTR
build_agent_gateway:
  stage: build
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "agent-gateway"
    DOCKERFILE_PATH: "agent_gateway/Dockerfile"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH
      changes:
        compare_to: 'refs/heads/main'
        paths:
          - agent_gateway/**
      when: always
    - if: $CI_COMMIT_BRANCH
      when: manual

# APA Web Bench Build - Push to MTR
build_apa_web_bench:
  stage: build
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "apa-web-bench"
    DOCKERFILE_PATH: "apa-web-bench/Dockerfile"
    ADDITIONAL_BUILD_ARGS: "--build-arg UV_INDEX_URL=${PYPI_INDEX_URL}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH
      changes:
        compare_to: 'refs/heads/main'
        paths:
          - apa-web-bench/**
      when: always
    - if: $CI_COMMIT_BRANCH
      when: manual

# Evaluator Build - Push to MTR
build_evaluator:
  stage: build
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "evaluator"
    DOCKERFILE_PATH: "evaluator/Dockerfile"
    ADDITIONAL_BUILD_ARGS: "--build-arg UV_INDEX_URL=${PYPI_INDEX_URL}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: always
    - if: $CI_COMMIT_BRANCH
      changes:
        compare_to: 'refs/heads/main'
        paths:
          - evaluator/**
      when: always
    - if: $CI_COMMIT_BRANCH
      when: manual

# ================================
# RELEASE JOBS (Git Tags)
# ================================

# Release jobs run only on git tags and create the '-latest' tags
# The .kaniko_build_single template automatically handles this

release_backend:
  stage: release
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "backend"
    DOCKERFILE_PATH: "backend/Dockerfile"
    ADDITIONAL_BUILD_ARGS: "--build-arg UV_INDEX_URL=${PYPI_INDEX_URL}"
  rules:
    - if: $CI_COMMIT_TAG
      when: always

release_frontend:
  stage: release
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "frontend"
    DOCKERFILE_PATH: "frontend/Dockerfile.prod"
  rules:
    - if: $CI_COMMIT_TAG
      when: always

release_agent_gateway:
  stage: release
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "agent-gateway"
    DOCKERFILE_PATH: "agent_gateway/Dockerfile"
  rules:
    - if: $CI_COMMIT_TAG
      when: always

release_apa_web_bench:
  stage: release
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "apa-web-bench"
    DOCKERFILE_PATH: "apa-web-bench/Dockerfile"
    ADDITIONAL_BUILD_ARGS: "--build-arg UV_INDEX_URL=${PYPI_INDEX_URL}"
  rules:
    - if: $CI_COMMIT_TAG
      when: always

release_evaluator:
  stage: release
  extends: .kaniko_build_single
  variables:
    IMAGE_NAME: "${MTR_REGISTRY}/${MTR_PROJECT_PATH}"
    IMAGE_TAG: "evaluator"
    DOCKERFILE_PATH: "evaluator/Dockerfile"
    ADDITIONAL_BUILD_ARGS: "--build-arg UV_INDEX_URL=${PYPI_INDEX_URL}"
  rules:
    - if: $CI_COMMIT_TAG
      when: always
