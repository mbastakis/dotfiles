# Istio Webhook Connectivity Issue - EKS Control Plane

## Current Status

❌ **Blocking Issue**: Istio webhooks cannot be reached by the EKS API server, preventing gateway pod creation.

## Root Cause Analysis

### The Problem

The AWS-managed EKS control plane (running the Kubernetes API server) **cannot reach** the istiod webhook service running on worker nodes. This causes two critical failures:

1. **Injection Webhook Timeout**:
   ```
   Error creating: Internal error occurred: failed calling webhook "namespace.sidecar-injector.istio.io":
   Post "https://istiod.istio-system.svc:443/inject?timeout=30s": context deadline exceeded
   ```
   - Blocks ALL pod creation in `istio-ingress` namespace
   - Gateway pods cannot be created
   - Webhook has `failurePolicy: Fail`, so failures block creation

2. **Validation Webhook Not Ready**:
   ```
   validationController: Not ready to switch validation to fail-closed: dummy invalid config not rejected
   ```
   - istiod validation controller cannot verify its webhooks
   - Webhooks remain in "fail-open" mode
   - Cannot validate Istio CRDs properly

### What We've Verified

✅ **Configuration is Correct**:
- istiod pods: **Running** (3/3 replicas)
- istiod service: **Exists** with correct endpoints
- istiod webhook: **Listening** on port 15017
- Webhook configuration: **Valid** (CA bundle, service name, path all correct)
- Injection configmap: **Contains** gateway template
- istio-cni: **Running** (6/6 daemonset pods)
- Namespace labels: **Correct** (`istio-injection: enabled`)
- Pod annotations: **Correct** (`inject.istio.io/templates: gateway`, `sidecar.istio.io/inject: "true"`)

✅ **Local Connectivity Works**:
- istiod pods can reach each other
- Injection endpoint responds when called from within istiod pod
- Service endpoints are properly configured

❌ **Control Plane Connectivity Fails**:
- API server (in AWS VPC) cannot reach worker node IPs
- Webhook calls timeout after 30 seconds
- No network path from control plane to istiod service

## Why This Happens in EKS

### EKS Architecture

```
┌─────────────────────────────────────┐
│   AWS-Managed Control Plane VPC     │
│  ┌───────────────────────────────┐  │
│  │   Kubernetes API Server       │  │
│  │   (Needs to call webhooks)    │  │
│  └──────────────┬────────────────┘  │
└─────────────────┼───────────────────┘
                  │ ❌ Timeout!
                  │
┌─────────────────┼───────────────────┐
│  Customer VPC (Worker Nodes)        │
│  ┌──────────────▼────────────────┐  │
│  │  istiod Service               │  │
│  │  Port 443 → targetPort 15017  │  │
│  │  ┌──────────────────────────┐ │  │
│  │  │ istiod pods: 10.91.58.x  │ │  │
│  │  │ Listening on :15017      │ │  │
│  │  └──────────────────────────┘ │  │
│  └───────────────────────────────┘  │
└─────────────────────────────────────┘
```

### Common Causes

1. **Security Group Rules**:
   - EKS cluster security group may not allow traffic from control plane ENIs to worker nodes on webhook ports
   - Default rules allow 443 and 10250, but webhook services use custom ports

2. **Network ACLs**:
   - VPC network ACLs may block traffic between subnets

3. **Service Endpoint Issues**:
   - DNS resolution problems
   - Service mesh networking conflicts

## Comparison with oneAI-infra

We checked the oneAI-infra cluster configuration and found:

**They DO NOT use**:
- `hostNetwork: true` for istiod
- Any special EKS-specific webhook configuration

**Conclusion**: Their EKS cluster has proper security group/network configuration that allows webhook traffic. Our cluster does not.

## Required Fix

### Option 1: Fix Security Groups (Recommended)

Add security group rules to allow EKS control plane to reach worker nodes on webhook ports.

**Location**: `/Users/mbastakis/dev/work/aicc-group/infrastructure/iac/aws/eks/terraform/main.tf`

**Required Change**:
```hcl
module "eks" {
  # ... existing config ...

  cluster_security_group_additional_rules = {
    internet = {
      type        = "egress"
      from_port   = 0
      to_port     = 0
      protocol    = "-1"
      cidr_blocks = ["0.0.0.0/0"]
      description = "Allow cluster egress access to the Internet"
    }

    # ADD THIS RULE:
    webhook_ingress = {
      type        = "ingress"
      from_port   = 443
      to_port     = 65535  # Allow all high ports for webhook services
      protocol    = "tcp"
      self        = true   # Allow traffic within cluster security group
      description = "Allow EKS control plane to reach webhook services (Istio, cert-manager, etc.)"
    }
  }
}
```

**Explanation**:
- EKS control plane and worker nodes share the cluster security group
- `self = true` allows traffic between resources with the same security group
- Port range 443-65535 covers all common webhook ports
- This is the standard solution for EKS + Istio

### Option 2: Use HostNetwork (NOT Recommended)

Enable `hostNetwork: true` for istiod pods. This allows the control plane to reach istiod via the node's IP address.

**Pros**:
- Quick workaround
- No infrastructure changes needed

**Cons**:
- Security implications (pods share host network namespace)
- Port conflicts possible
- Not used by oneAI-infra
- Not a proper long-term solution

### Option 3: Disable Webhook Failure Policy (NOT Recommended)

Change webhook `failurePolicy` from `Fail` to `Ignore`.

**Pros**:
- Pods can be created even if webhook fails

**Cons**:
- Injection won't happen (pods created with `image: auto`)
- Gateway pods still won't work
- Defeats the purpose of webhooks
- Security risk (validation bypassed)

## Next Steps

1. **Apply Security Group Fix**:
   ```bash
   cd /Users/mbastakis/dev/work/aicc-group/infrastructure/iac/aws/eks/terraform

   # Edit main.tf to add webhook_ingress rule
   # ... make the change ...

   # Review the plan
   terraform plan

   # Apply the change
   terraform apply
   ```

2. **Verify Webhook Connectivity**:
   After applying the security group change, verify webhooks start working:
   ```bash
   # Check istiod logs - should see webhooks become ready
   kubectl logs -n istio-system deployment/istiod | grep "validation"

   # Try creating a test pod in istio-ingress namespace
   kubectl run test-pod --image=nginx -n istio-ingress --rm -it

   # If successful, webhook injection is working!
   ```

3. **Verify Gateway Deployment**:
   ```bash
   # Gateway pods should now be created successfully
   kubectl get pods -n istio-ingress

   # Should show 3/3 Running gateway pods
   ```

## Alternative Investigation

If security group fix doesn't resolve the issue, investigate:

1. **Network ACLs**: Check VPC network ACLs allow traffic between control plane and worker subnets
2. **CNI Configuration**: Verify AWS VPC CNI is working correctly
3. **DNS Resolution**: Test if API server can resolve `istiod.istio-system.svc`
4. **Istio CNI Logs**: Check for any CNI plugin errors
   ```bash
   kubectl logs -n istio-system daemonset/istio-cni-node
   ```

## References

- [EKS Best Practices - Webhook Configuration](https://aws.github.io/aws-eks-best-practices/security/docs/iam/#restrict-access-to-the-instance-profile-assigned-to-the-worker-node)
- [Istio on EKS - Security Groups](https://istio.io/latest/docs/setup/platform-setup/amazon/)
- [EKS Cluster Security Group Requirements](https://docs.aws.amazon.com/eks/latest/userguide/sec-group-reqs.html)

---

**Document Version**: 1.0
**Date**: October 21, 2025
**Status**: ❌ Blocking - Requires Infrastructure Fix
