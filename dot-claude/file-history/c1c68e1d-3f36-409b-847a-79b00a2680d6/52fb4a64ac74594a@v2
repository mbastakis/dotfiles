# AICC Dev Environment Values for Istio Ingress Gateway
# This file contains dev-specific configuration for the Istio ingress gateway
# with AWS NLB integration matching the nginx-ingress pattern.

# Global Istio configuration (required by gateway subchart for image resolution)
global:
  hub: dockerhub.devops.telekom.de/istio
  tag: "1.26.3"
  istioNamespace: istio-system

# Override gateway chart values
gateway:
  name: istio-ingressgateway
  labels:
    app: istio-ingressgateway
    istio: ingressgateway
  
  # Disable sidecar injection for gateway pods (they ARE the proxy)
  podAnnotations:
    sidecar.istio.io/inject: "false"
  
  replicaCount: 3
  
  # Service configuration with NLB annotations (matching nginx-ingress pattern)
  service:
    type: LoadBalancer
    externalTrafficPolicy: Local
    annotations:
      # NLB Type
      service.beta.kubernetes.io/aws-load-balancer-type: "external"
      service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: "ip"
      service.beta.kubernetes.io/aws-load-balancer-scheme: "internal"
      service.beta.kubernetes.io/aws-load-balancer-name: "istio-dev-nlb"
      
      # TLS Configuration
      service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:eu-central-1:076811069858:certificate/d6a2ef2b-2eb8-4c17-8cf2-917a730d411d"
      service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"
      service.beta.kubernetes.io/aws-load-balancer-ssl-negotiation-policy: "ELBSecurityPolicy-TLS13-1-2-Res-2021-06"
      service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
      
      # Access Logs
      service.beta.kubernetes.io/aws-load-balancer-access-log-enabled: "true"
      service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-name: "aicc-cndtag-dev-internal-nlb-access-logs"
      service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-prefix: "istio-nlb"
      
      # Subnets (same as nginx-ingress)
      service.beta.kubernetes.io/aws-load-balancer-subnets: "subnet-07ab7fda96660795f,subnet-07d444dc79d00631c,subnet-07f7fc2361a24d37e"
      
      # Cross-zone load balancing
      service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
      service.beta.kubernetes.io/aws-load-balancer-ip-address-type: "ipv4"
    
    ports:
      - name: status-port
        port: 15021
        protocol: TCP
        targetPort: 15021
      - name: http2
        port: 80
        protocol: TCP
        targetPort: 80
      - name: https
        port: 443
        protocol: TCP
        targetPort: 8080  # NLB terminates TLS, forwards HTTP to 8080
  
  # Security context (non-root, read-only filesystem)
  securityContext:
    sysctls:
      - name: net.ipv4.ip_unprivileged_port_start
        value: "0"
    fsGroup: 1337
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault
    supplementalGroups:
      - 1337
  
  containerSecurityContext:
    capabilities:
      drop:
        - ALL
    allowPrivilegeEscalation: false
    privileged: false
    readOnlyRootFilesystem: true
    runAsUser: 1337
    runAsGroup: 1337
    runAsNonRoot: true
  
  # Resources
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 1000m
      memory: 512Mi
  
  # Autoscaling
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 6
    targetCPUUtilizationPercentage: 80
  
  # PodDisruptionBudget
  podDisruptionBudget:
    maxUnavailable: 1
  
  # Pod anti-affinity for HA across nodes and zones
  affinity:
    podAntiAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
              - key: app
                operator: In
                values:
                  - istio-ingressgateway
          topologyKey: kubernetes.io/hostname
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          podAffinityTerm:
            labelSelector:
              matchExpressions:
                - key: app
                  operator: In
                  values:
                    - istio-ingressgateway
            topologyKey: topology.kubernetes.io/zone
  
  # Topology spread constraints for even distribution across zones
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: DoNotSchedule
      labelSelector:
        matchLabels:
          app: istio-ingressgateway

# Gateway CRD configuration
istioGateway:
  enabled: true
  name: main-gateway
  hosts:
    - "*.dev.aicc.aws.telekom.de"
    - "*.internal.dev.aicc.aws.telekom.de"
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - "*.dev.aicc.aws.telekom.de"
        - "*.internal.dev.aicc.aws.telekom.de"
      tls:
        httpsRedirect: true
    - port:
        number: 443
        name: https
        protocol: HTTPS
      hosts:
        - "*.dev.aicc.aws.telekom.de"
        - "*.internal.dev.aicc.aws.telekom.de"
      tls:
        mode: PASSTHROUGH  # TLS terminated at NLB, this is for protocol awareness
