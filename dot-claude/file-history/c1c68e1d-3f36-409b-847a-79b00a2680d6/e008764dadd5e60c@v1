# Namespace Configuration for Istio Sidecar Injection

## Overview

This document describes the namespace labeling strategy for Istio sidecar injection in the AICC infrastructure. Proper namespace labeling is crucial for controlling which applications participate in the service mesh.

## Current Configuration

### Injection Enabled Namespaces

| Namespace | Label | Rationale |
|-----------|-------|-----------|
| `fiber-magenta-apprentice` | `istio-injection=enabled` | Multi-service application that benefits from mesh features including traffic management, security policies, and observability |

**Benefits for mesh-enabled namespaces:**
- Automatic sidecar proxy injection for new pods
- Service-to-service communication encryption (when mTLS enabled)
- Advanced traffic management capabilities
- Distributed tracing and observability
- Circuit breaking and retry policies
- Load balancing and failover

### Injection Disabled Namespaces

| Namespace | Label | Rationale |
|-----------|-------|-----------|
| `keycloak` | `istio-injection=disabled` | Contains PostgreSQL database which is incompatible with HTTP proxy sidecars. Database connections use direct TCP without HTTP layer |

**Rationale for database exceptions:**
- PostgreSQL uses wire protocol over TCP, not HTTP
- Istio proxy operates at HTTP/HTTPS layer
- Database connection pooling incompatible with HTTP proxy
- Performance implications of unnecessary proxy overhead
- Existing connection patterns must be preserved

### Infrastructure Namespaces

| Namespace | Purpose | Injection Status |
|-----------|---------|------------------|
| `istio-system` | Istio control plane components | Not labeled (defaults to disabled for system namespaces) |
| `istio-ingress` | Istio gateway components | **Injection enabled** (required for gateway Helm chart) |

**Important Note on istio-ingress**: While this is an infrastructure namespace, the Istio gateway Helm chart (using `image: auto`) requires sidecar injection to function. The gateway pods use the `inject.istio.io/templates: gateway` annotation to receive a specialized gateway configuration during injection, not a standard sidecar. Therefore, this namespace must have `istio-injection: enabled` despite being an infrastructure component.

## Implementation Details

### Namespace Labeling Commands

The following kubectl commands were used to configure the namespaces:

```bash
# Enable injection for application namespace
kubectl label namespace fiber-magenta-apprentice istio-injection=enabled --overwrite

# Disable injection for database namespace
kubectl label namespace keycloak istio-injection=disabled --overwrite

# Enable injection for gateway namespace (required for gateway Helm chart)
kubectl label namespace istio-ingress istio-injection=enabled --overwrite
```

### Verification Commands

Use these commands to verify the current configuration:

```bash
# Check all namespace labels
kubectl get namespaces fiber-magenta-apprentice keycloak istio-system istio-ingress \
  -o jsonpath='{range .items[*]}{.metadata.name}{": "}{.metadata.labels.istio-injection}{"\n"}{end}'

# Verify specific namespace labels
kubectl get ns fiber-magenta-apprentice -o jsonpath='{.metadata.labels.istio-injection}'  # Should return "enabled"
kubectl get ns keycloak -o jsonpath='{.metadata.labels.istio-injection}'  # Should return "disabled"
kubectl get ns istio-ingress -o jsonpath='{.metadata.labels.istio-injection}'  # Should return "enabled"

# List all namespaces with injection labels
kubectl get namespaces -l istio-injection --show-labels
```

## Future Namespace Onboarding

When adding new namespaces to the cluster, follow this decision matrix:

### Enable Istio Injection (`istio-injection=enabled`) For:
- Application services that communicate via HTTP/gRPC
- Microservices that benefit from service mesh features
- Services requiring advanced traffic management
- Applications needing observability and security features

### Disable Istio Injection (`istio-injection=disabled`) For:
- Database systems (PostgreSQL, MySQL, Redis, etc.)
- Legacy applications with incompatible networking
- Services with custom proxy requirements
- High-performance applications where proxy overhead is critical

### Process for New Namespaces

1. **Assessment**: Evaluate the application type and networking requirements
2. **Labeling**: Apply appropriate `istio-injection` label
3. **Testing**: Verify application functionality after labeling
4. **Documentation**: Update this document with the new namespace
5. **Monitoring**: Ensure observability is working as expected

## Service Mesh Migration Strategy

The namespace labeling supports a phased migration approach:

### Phase 1 (Current): Selective Enablement
- Only `fiber-magenta-apprentice` namespace has injection enabled
- Database namespaces explicitly disabled
- Infrastructure namespaces properly configured

### Phase 2 (Future): Expanded Coverage
- Additional application namespaces can be labeled for injection
- mTLS policies will be configured (currently in DISABLE mode)
- Advanced traffic management features activated

### Phase 3 (Future): Full Mesh
- Most application namespaces participating in mesh
- Strict mTLS policies where appropriate
- Complete observability and security policy enforcement

## Troubleshooting

### Common Issues

**Pods not getting sidecars in labeled namespace:**
```bash
# Check if namespace has correct label
kubectl get ns <namespace> -o jsonpath='{.metadata.labels.istio-injection}'

# Check istiod is running
kubectl get pods -n istio-system

# Check admission webhook
kubectl get mutatingadmissionwebhooks
```

**Application connectivity issues after labeling:**
```bash
# Check if services need port name updates for Istio
kubectl get svc -n <namespace> -o yaml | grep -E "name:|port:"

# Verify Istio proxy status
kubectl get pods -n <namespace> -o jsonpath='{.items[*].spec.containers[*].name}'
```

**Database connectivity broken:**
```bash
# Verify injection is disabled
kubectl get ns <db-namespace> -o jsonpath='{.metadata.labels.istio-injection}'

# Should return "disabled" or empty (not "enabled")
```

## References

- [Istio Sidecar Injection Documentation](https://istio.io/latest/docs/setup/additional-setup/sidecar-injection/)
- [Architecture Decision: docs/istio-architecture-decision.md](../istio-architecture-decision.md)
- [Epic 001: Infrastructure Foundation](../epic-001-infrastructure-foundation.md)
- [Story 1.3: Namespace Configuration](../stories/1.3.namespace-configuration.md)

---

*Document Version: 1.0*  
*Last Updated: 2025-09-30*  
*Author: James (Dev Agent)*