## Project Overview

This is a GitLab group containing multiple repositories for a Kubernetes-based application platform. The structure is divided into two main areas:

- **`fiber/`**: Application code repositories (Fiber is the use case/application layer)
- **`infrastructure/`**: Infrastructure and platform support repositories
- **`specs/`**: Specifications and documentation

### Architecture Diagram

```mermaid
graph TB
    subgraph "AWS Account"
        subgraph "Terraform Infrastructure"
            TF_EKS[EKS Cluster<br/>infrastructure/iac/aws/eks]
            TF_IAM[IAM Roles & Policies<br/>infrastructure/iac/aws/iam]
            TF_K8S[K8s Core Components<br/>infrastructure/iac/aws/k8s-core<br/>ArgoCD, Karpenter]
        end

        subgraph "EKS Cluster - Dev Environment"
            subgraph "ArgoCD Management Layer"
                ROOT_AOA[Root App of Apps<br/>infrastructure/argocd/root-app-of-apps]

                subgraph "Infrastructure Apps"
                    INFRA_AOA[Dev Core K8s Infra<br/>App of Apps]
                    INFRA_HELM[Infrastructure Helm Charts<br/>infrastructure/argocd/helm-charts]

                    KEYCLOAK[Keycloak]
                    LABELSTUDIO[LabelStudio]
                    LANGFUSE[Langfuse]
                    N8N[n8n]
                    OTHER_INFRA[Other Shared Services]
                end

                subgraph "Application Apps"
                    FIBER_AOA[Dev Fiber App of Apps<br/>fiber/argocd/dev-root-fiber-app-of-apps]
                    FIBER_HELM[Fiber Helm Charts<br/>fiber/argocd/helm-charts]

                    MAGENTA[Magenta Apprentice<br/>Main Application<br/>Python/React/Go]
                    MAGENTA_HELM[magenta-apprentice-helm]
                end
            end
        end
    end

    subgraph "Application Code"
        MAGENTA_CODE[fiber/magenta-apprentice<br/>Application Source Code]
    end

    subgraph "CI/CD"
        WORKHORSE[Work Horse Image<br/>infrastructure/work-horse-image<br/>CI/CD Docker Images]
    end

    subgraph "Documentation & Specs"
        DOCS[./docs/<br/>AI-managed documentation]
        QA[./qa/<br/>AI-managed QA files]
        SPECS_DIR[./specs/<br/>AI-managed specifications]
    end

    %% Infrastructure Flow
    TF_EKS -->|Creates| ROOT_AOA
    TF_IAM -->|Configures| ROOT_AOA
    TF_K8S -->|Deploys| ROOT_AOA

    %% ArgoCD Structure
    ROOT_AOA -->|Manages| INFRA_AOA
    ROOT_AOA -->|Manages| FIBER_AOA

    %% Infrastructure Apps Flow
    INFRA_AOA -->|Uses| INFRA_HELM
    INFRA_HELM -->|Deploys| KEYCLOAK
    INFRA_HELM -->|Deploys| LABELSTUDIO
    INFRA_HELM -->|Deploys| LANGFUSE
    INFRA_HELM -->|Deploys| N8N
    INFRA_HELM -->|Deploys| OTHER_INFRA

    %% Application Apps Flow
    FIBER_AOA -->|Uses| FIBER_HELM
    FIBER_HELM -->|Contains| MAGENTA_HELM
    MAGENTA_HELM -->|Deploys| MAGENTA
    MAGENTA_CODE -->|Built & Packaged for| MAGENTA

    %% CI/CD Flow
    WORKHORSE -.->|Builds| MAGENTA_CODE

    %% Shared Services Dependencies
    MAGENTA -->|Uses| KEYCLOAK
    MAGENTA -->|Uses| LABELSTUDIO
    MAGENTA -->|Uses| LANGFUSE
    MAGENTA -->|Uses| N8N

    %% Styling
    classDef terraform fill:#7B42BC,stroke:#5C2D91,color:#fff
    classDef argocd fill:#EF7B4D,stroke:#D45835,color:#fff
    classDef app fill:#326CE5,stroke:#2451B7,color:#fff
    classDef infra fill:#FF6B35,stroke:#D45426,color:#fff
    classDef docs fill:#48C9B0,stroke:#36A08A,color:#fff

    class TF_EKS,TF_IAM,TF_K8S terraform
    class ROOT_AOA,INFRA_AOA,FIBER_AOA argocd
    class MAGENTA,MAGENTA_CODE,MAGENTA_HELM app
    class KEYCLOAK,LABELSTUDIO,LANGFUSE,N8N,OTHER_INFRA,INFRA_HELM,FIBER_HELM,WORKHORSE infra
    class DOCS,QA,SPECS_DIR docs
```

### Deployment Flow

```mermaid
sequenceDiagram
    participant Dev as Developer
    participant Code as fiber/magenta-apprentice
    participant CI as CI/CD Pipeline
    participant Helm as Helm Charts
    participant ArgoCD as ArgoCD
    participant K8s as EKS Cluster

    Dev->>Code: Push code changes
    Code->>CI: Trigger build
    CI->>CI: Build application<br/>(Python/React/Go)
    CI->>CI: Create container images
    CI->>Helm: Update image tags
    Helm->>ArgoCD: Detect changes
    ArgoCD->>ArgoCD: Sync application
    ArgoCD->>K8s: Apply manifests
    K8s->>K8s: Deploy/Update pods
    K8s-->>Dev: Application deployed
```

### Environment Structure

```mermaid
graph LR
    subgraph "Environments"
        DEV[Dev Environment<br/>dev-root-app-of-apps]
        PROD[Prod Environment<br/>prod-root-app-of-apps]
        PLAY[Playground Environment<br/>playground-root-app-of-apps]
    end

    subgraph "Current Focus"
        DEV_DETAIL[Dev Environment<br/>✓ Infrastructure Apps<br/>✓ Fiber Apps<br/>✓ Shared Services]
    end

    DEV -.->|Working on| DEV_DETAIL
    PROD -.->|Future| PROD
    PLAY -.->|Testing| PLAY

    classDef active fill:#4CAF50,stroke:#388E3C,color:#fff
    classDef inactive fill:#9E9E9E,stroke:#616161,color:#fff

    class DEV,DEV_DETAIL active
    class PROD,PLAY inactive
```

### Repository Structure

```
aicc-group/
├── fiber/                                    # Application layer
│   ├── magenta-apprentice/                  # Main application (Python/React/Go)
│   ├── argocd/                             # ArgoCD app-of-apps for Fiber
│   │   ├── dev-root-fiber-app-of-apps/    
│   │   ├── prod-root-fiber-app-of-apps/   
│   │   └── helm-charts/                    # Helm charts for Fiber apps
│   └── scripts/                            # Support scripts
│
├── infrastructure/                          # Infrastructure layer
│   ├── iac/aws/                           # Terraform infrastructure as code
│   │   ├── eks/                           # EKS cluster management
│   │   ├── iam/                           # IAM roles and policies
│   │   └── k8s-core/                      # Core Kubernetes components
│   ├── argocd/                            # ArgoCD infrastructure apps
│   │   ├── root-app-of-apps/              # Environment entry points
│   │   │   ├── dev-root-app-of-apps/
│   │   │   ├── prod-root-app-of-apps/
│   │   │   └── playground-root-app-of-apps/
│   │   ├── dev-core-kubernetes-infra-app-of-apps/   # Shared services
│   │   └── helm-charts/                    # Infrastructure Helm charts
│   └── work-horse-image/                   # CI/CD Docker images
│
└── specs/                                   # Specifications
```

## Index

This is a gitlab group for all the repositories in a project. 
It contains the following repositories at the top level:

./fiber : A gitlab subgroup for all fiber related repositories. Fiber is a use case so essentially the application code.
./infrastructure : A gitlab subgroup for all infrastructure related repositories. Infrastructure is everything that supports the application code.

For now we are working in the dev environment. The dev environment is a kubernetes cluster in aws. For the dev environment we have the following repositories:
- ./infrastructure/argocd/root-app-of-apps: This repository contains the argocd application for the root app of apps. This is the entry point for argocd root app of apps, In each different environment. We care only about dev for now.
  - ./infrastructure/argocd/dev-core-kubernetes-infra-app-of-apps: This is the root app of apss for the dev environment and especcially for core kubernetes infra services. This are the shared services which are used by all the applications. Contains:
  Keycloak, labelstudio, langfuse, n8n etc.
  - ./infrastructure/argocd/helm-charts: This is a gitlab subgroup. It contains all the helm charts for the applications and services we use for the dev-core-kubernetes-infra-app-of-apps.

./infrastructure/iac/aws: This repository contains the terraform code for the aws infrastructure.
  ./infrastructure/iac/aws/eks: This repository contains the terraform code for the eks cluster.
  ./infrastructure/iac/aws/iam: This repository contains the terraform code for the iam roles and policies.
  ./infrastructure/iac/aws/k8s-core: gitlab_group_access_token, argocd, argocd_project, karpenter etc.

./fiber/argocd/dev-root-fiber-app-of-apps: This is the root app of apps for the dev environment and especially for fiber applications. This contains all the fiber applications.
  - ./fiber/argocd/helm-charts: This is a gitlab subgroup. It contains all the helm charts for the fiber applications.
./fiber/magenta-apprentice: This repository contains the code for the magenta apprentice application. This is our main application. The helm charts for this application are in ./fiber/argocd/helm-charts/magenta-apprentice-helm 


---

./docs/ : This folder contains all the documentation related to the project. This is an ai managed directory. You can add any documentation you want here. You can create subfolders and files as you want. The documentation is in markdown format.

./qa/ : This folder contains all the qa related files. This is an ai managed directory. You can add any qa related files you want here. You can create subfolders and files as you want. The qa files are in markdown format.

./specs/ : This folder contains all the specifications related to the project. This is an ai managed directory. You can add any specifications you want here. You can create subfolders and files as you want. The specifications are in markdown format.

## Tools
You have access to the aws cli
You have access to the kubectl cli
You have access to the helm cli

---

You shall run kubectl and aws commands to understand the current state of the cluster and the aws account and debug.

---

Most of the things you do should be as code and not manual. You can create terraform code, helm charts, kubectl manifests etc.
When you want to deploy a change you shall ask me.

---

Use to gain access to the aws account, keep in mind this is a global script, you need to use this before any aws command, you can use this command from any directory:
```
source aws-switch-profile.sh dev
```
---

Terraform state for /Users/mbastakis/dev/work/aicc-group/infrastructure/iac/aws/k8s-core:
export GITLAB_ACCESS_TOKEN=REDACTED_GITLAB_TOKEN
export TF_STATE_NAME=dev
terraform init \
    -backend-config="address=https://gitlab.devops.telekom.de/api/v4/projects/382306/terraform/state/$TF_STATE_NAME" \
    -backend-config="lock_address=https://gitlab.devops.telekom.de/api/v4/projects/382306/terraform/state/$TF_STATE_NAME/lock" \
    -backend-config="unlock_address=https://gitlab.devops.telekom.de/api/v4/projects/382306/terraform/state/$TF_STATE_NAME/lock" \
    -backend-config="username=michail.bastakis" \
    -backend-config="password=$GITLAB_ACCESS_TOKEN" \
    -backend-config="lock_method=POST" \
    -backend-config="unlock_method=DELETE" \
    -backend-config="retry_wait_min=5"

---

Terraform state for /Users/mbastakis/dev/work/aicc-group/infrastructure/iac/aws/eks:
export GITLAB_ACCESS_TOKEN=REDACTED_GITLAB_TOKEN
export TF_STATE_NAME=dev
terraform init \
    -backend-config="address=https://gitlab.devops.telekom.de/api/v4/projects/377761/terraform/state/$TF_STATE_NAME" \
    -backend-config="lock_address=https://gitlab.devops.telekom.de/api/v4/projects/377761/terraform/state/$TF_STATE_NAME/lock" \
    -backend-config="unlock_address=https://gitlab.devops.telekom.de/api/v4/projects/377761/terraform/state/$TF_STATE_NAME/lock" \
    -backend-config="username=michail.bastakis" \
    -backend-config="password=$GITLAB_ACCESS_TOKEN" \
    -backend-config="lock_method=POST" \
    -backend-config="unlock_method=DELETE" \
    -backend-config="retry_wait_min=5"
    
