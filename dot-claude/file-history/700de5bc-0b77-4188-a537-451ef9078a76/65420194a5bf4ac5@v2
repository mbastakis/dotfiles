# Production values for istiod control plane
# This configuration implements high availability, observability, and resource management
# for production Istio service mesh deployments

# Values for the istiod subchart (production configuration)
istiod:
  # Global Istio configuration
  global:
    # Corporate container registry configuration for AICC environments
    # All Istio images are pulled from the corporate registry for security and compliance
    hub: dockerhub.devops.telekom.de/istio
    
    # Control plane namespace
    istioNamespace: istio-system
    
    # Mesh-wide configuration for all workloads
    meshConfig:
      # Enable structured JSON logging for centralized log aggregation (AC: 4)
      # Ensures compatibility with corporate logging infrastructure
      accessLogFile: /dev/stdout
      accessLogEncoding: JSON

      # Mutual TLS security configuration
      # Enforce TLS 1.3 minimum for enhanced security
      meshMTLS:
        minProtocolVersion: TLSV1_3

      # Default configuration for all sidecar proxies
      defaultConfig:
        # Ensure application containers wait for sidecar proxy startup (AC: 4)
        # Prevents race conditions during pod initialization
        holdApplicationUntilProxyStarts: true
        
        # Proxy resource configuration for all sidecar containers (AC: 3)
        # Conservative limits prevent resource starvation while allowing burst capacity
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
          limits:
            cpu: 500m  # 10x burst capacity for traffic spikes
            memory: 128Mi  # 2x ratio prevents OOMKilled conditions
    
    # Proxy initialization configuration
    proxy_init:
      resources:
        requests:
          cpu: 10m
          memory: 16Mi
        limits:
          cpu: 100m
          memory: 32Mi

  # Pilot (Istiod control plane) configuration - this is the main configuration section
  pilot:
    # CNI Configuration - CRITICAL for proper Istio operation
    # CNI plugin handles network configuration without requiring privileged init containers
    cni:
      enabled: true

    # High Availability Configuration (AC: 2, 5)
    # Minimum 2 replicas with autoscaling for production resilience
    autoscaleEnabled: true
    autoscaleMin: 2
    autoscaleMax: 3
    
    # CPU-based horizontal pod autoscaling (70% threshold)
    # Scales when aggregate CPU usage exceeds 70% of requests
    cpu:
      targetAverageUtilization: 70
    
    # Production Resource Requirements (AC: 3)
    # Per-replica resource allocation for istiod pods
    resources:
      requests:
        cpu: 250m     # Per-replica baseline for node scheduling (AC: 3)
        memory: 512Mi # Per-replica memory baseline for mesh management
      limits:
        cpu: 2000m    # 8x burst capacity for configuration pushes (AC: 3)
        memory: 1Gi   # 2x ratio prevents OOMKilled, handles memory spikes
    
    # Observability and monitoring configuration (AC: 4)
    env:
      # Enable comprehensive Prometheus metrics collection
      PILOT_ENABLE_PROMETHEUS_METRICS: true
      
      # JSON logging configuration for structured log output
      PILOT_LOG_LEVEL: info
      PILOT_TRACE_SAMPLING: 1.0
      
      # Service registry configuration for multi-cluster support
      PILOT_ENABLE_CROSS_CLUSTER_WORKLOAD_ENTRY: true
      PILOT_ENABLE_WORKLOAD_ENDPOINTS: true
      
      # Enable external control plane mode for multi-cluster scenarios
      EXTERNAL_ISTIOD: false